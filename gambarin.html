<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TikTok Affiliate AI Suite (v23) - Dark Pink Theme</title>
    <script src="https://cdn-tailwindcss.vercel.app/"></script> <!-- Using Vercel CDN for full Tailwind features -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Dark Blue Theme */
        :root {
            --bg-primary: #111111; /* Near Black */
            --bg-secondary: #1f1f1f; /* Dark Gray */
            --bg-tertiary: #2d2d2d; /* Slightly Lighter Gray */
            --text-primary: #e5e7eb; /* Light Gray */
            --text-secondary: #9ca3af; /* Medium Gray */
            --accent-primary: #ec4899; /* Pink 500 */
            --accent-hover: #db2777; /* Pink 600 */
            --border-color: #374151; /* Gray 700 - adjusted slightly */
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
        }
        .sidebar {
            background-color: var(--bg-secondary);
            transition: transform 0.3s ease-in-out;
        }
        .sidebar-link.active {
            background-color: var(--accent-primary);
            color: #ffffff; /* White text on pink */
            font-weight: 600;
        }
        .sidebar-link:not(.active):hover {
             background-color: var(--bg-tertiary);
        }
        .tool-card { display: none; }
        .tool-card.active { display: block; }

        .drop-zone, .sb-image-upload-box {
            border: 2px dashed var(--border-color);
            border-radius: 0.5rem;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            background-color: var(--bg-secondary);
            color: var(--text-secondary);
        }
        .drop-zone:hover, .sb-image-upload-box:hover,
        .drop-zone.dragover {
            border-color: var(--accent-primary);
            background-color: var(--bg-tertiary);
        }

        /* Loader/Spinner */
        .loader, .spinner, .custom-loader {
            border-color: rgba(255, 255, 255, 0.2);
            border-top-color: var(--accent-primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
         /* Overriding custom loader slightly for theme */
        .custom-loader {
             background:
                radial-gradient(farthest-side, var(--accent-primary) 94%,#0000) top/8px 8px no-repeat,
                conic-gradient(#0000 30%, var(--accent-primary));
             -webkit-mask: radial-gradient(farthest-side,#0000 calc(100% - 8px),#000 0);
             animation: l13 1s infinite linear; /* Use different animation name if spin conflicts */
        }
        @keyframes l13 { 100%{transform: rotate(1turn)} }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* JSON Output */
        #json-output-container, #json-output-container-7 {
            background-color: var(--bg-secondary);
            border-radius: 0.5rem;
            padding: 1rem;
            color: var(--text-primary);
            white-space: pre-wrap; word-wrap: break-word; font-family: monospace;
            border: 1px solid var(--border-color);
        }

        /* Forms */
        .form-input, .form-select, .form-textarea,
        .sb-form-input, .sb-form-select, .sb-form-textarea {
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            border-radius: 0.375rem; /* rounded-md */
            padding: 0.75rem 1rem; /* p-3 */
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .form-input:focus, .form-select:focus, .form-textarea:focus,
        .sb-form-input:focus, .sb-form-select:focus, .sb-form-textarea:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 2px rgba(236, 72, 153, 0.4); /* Pink focus ring */
        }
        select.form-select, select.sb-form-select {
             padding-right: 2.5rem; /* space for arrow */
        }

        /* Buttons */
        .btn, button { transition: all 0.2s ease-in-out; }
        .btn-primary, .sb-btn-primary {
            background-color: var(--accent-primary);
            color: #ffffff; /* White text on pink */
            font-weight: 600;
        }
        .btn-primary:hover:not(:disabled), .sb-btn-primary:hover:not(:disabled) {
             background-color: var(--accent-hover);
        }
        .btn-primary:active:not(:disabled), .sb-btn-primary:active:not(:disabled) {
             transform: scale(0.98);
        }
        .btn-primary:disabled, .sb-btn-primary:disabled {
            background-color: var(--bg-tertiary);
            color: var(--text-secondary);
            cursor: not-allowed; opacity: 0.6;
        }
        .btn-secondary, .sb-btn-secondary {
            background-color: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }
        .btn-secondary:hover:not(:disabled), .sb-btn-secondary:hover:not(:disabled) {
            background-color: #444; /* Slightly lighter gray on hover */
        }
        .btn-secondary:active:not(:disabled), .sb-btn-secondary:active:not(:disabled) {
             transform: scale(0.98);
        }

        /* Aspect Ratio Buttons */
        .aspect-ratio-btn, .sb-aspect-ratio-btn {
             border: 2px solid var(--border-color);
             background-color: var(--bg-secondary);
             color: var(--text-secondary);
        }
        .aspect-ratio-btn.active, .sb-aspect-ratio-btn.active {
            border-color: var(--accent-primary);
            background-color: var(--accent-hover);
            color: #ffffff; /* White text on pink */
        }

        /* Card Styles */
        .tool-card > div:first-of-type { /* Direct child div containing the tool */
             background-color: var(--bg-secondary);
             border: 1px solid var(--border-color);
        }
        .storyboard-panel {
             background-color: var(--bg-tertiary);
             border: 1px solid var(--border-color);
             opacity: 0;
             animation: fadeIn 0.5s ease-out forwards;
        }
        .sb-image-preview-container { position: relative; }
        .sb-remove-image-btn {
            position: absolute; top: -0.5rem; right: -0.5rem;
            background-color: rgba(31, 31, 31, 0.8); /* Dark Gray with alpha */
            border-radius: 9999px; cursor: pointer;
            color: var(--text-secondary);
        }
        .sb-remove-image-btn:hover { color: var(--text-primary); }

        /* Toast */
        .toast {
            min-width: 150px; background-color: #222; /* Darker Toast */
            color: var(--text-primary); text-align: center; border-radius: 8px;
            padding: 12px; position: fixed; z-index: 100; left: 50%;
            transform: translateX(-50%); bottom: 30px;
            visibility: hidden; opacity: 0;
            transition: opacity 0.3s, visibility 0.3s;
        }
        .toast.show { visibility: visible; opacity: 1; }

        /* Image result card */
        .result-card {
             background-color: var(--bg-primary); /* Use primary bg for contrast */
             border: 1px solid var(--border-color);
        }
        .result-card img { background-color: var(--bg-tertiary); }
        .result-card a { /* Download link */
            background-color: var(--accent-primary);
            color: var(--bg-primary);
        }
         .result-card a:hover { background-color: var(--accent-hover); }

        /* NEW */
        .result-card .delete-btn {
            background-color: var(--bg-tertiary);
            color: var(--text-secondary);
            transition: all 0.2s ease-in-out;
        }
        .result-card .delete-btn:hover {
            background-color: #dc2626; /* red-600 */
            color: var(--text-primary);
        }
        /* END NEW */

        /* New Pulse Animation */
        @keyframes pulse-bg {
            0%, 100% { background-color: var(--bg-tertiary); }
            50% { background-color: #3f3f46; } /* Gray 600 - slightly lighter */
        }
        .pulse-placeholder {
            animation: pulse-bg 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
            border-radius: 0.5rem; /* rounded-lg */
            width: 100%;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    </style>
</head>
<body class="bg-gray-900 text-gray-200"> <!-- Body class may be overridden by style block -->
    <div class="relative min-h-screen md:flex">
        <!-- Mobile Menu Button -->
        <div class="md:hidden flex justify-between items-center p-4 bg-gray-800 text-white" style="background-color: var(--bg-secondary); border-bottom: 1px solid var(--border-color);">
            <h1 class="text-xl font-bold" style="color: var(--text-primary);">Affiliate AI Suite</h1>
            <button id="mobile-menu-button">
                <i data-lucide="menu" class="w-6 h-6"></i>
            </button>
        </div>

        <!-- Sidebar -->
        <aside id="sidebar" class="w-64 p-4 space-y-2 flex flex-col fixed inset-y-0 left-0 transform -translate-x-full md:relative md:translate-x-0 transition-transform duration-200 ease-in-out z-30"> <!-- Class overrides style block -->
             <div class="flex justify-between items-center mb-6">
                <div class="flex items-center gap-2">
                    <!-- Ini adalah logo SVG placeholder baru -->
                    <svg width="28" height="28" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="rounded-md">
                        <rect width="24" height="24" rx="6" fill="#ec4899"/>
                        <rect x="6" y="6" width="12" height="12" rx="3" fill="#111111"/>
                        <rect x="12" y="12" width="6" height="6" rx="2" fill="#ec4899"/>
                    </svg>
                    <!-- Teks diubah dari SNDLYNX menjadi GAMBARIN -->
                    <div>
                        <h1 class="text-2xl font-bold text-white leading-tight">GAMBARIN</h1>
                        <p class="text-xs" style="color: var(--text-secondary);">ciptakan imajinasimu dari ketikan</p>
                    </div>
                </div>
                <button id="close-menu-button" class="md:hidden">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            <div class="flex-grow">
                <a href="#" class="sidebar-link active flex items-center p-3 rounded-lg transition-colors" data-tool="image-to-prompt">
                    <i data-lucide="image-plus" class="w-5 h-5 mr-3"></i>
                    Gambar ke Prompt
                </a>
                 <a href="#" class="sidebar-link flex items-center p-3 rounded-lg transition-colors" data-tool="image-to-image-style">
                    <i data-lucide="image" class="w-5 h-5 mr-3"></i>
                    Gambar ke Gambar
                </a>
                <a href="#" class="sidebar-link flex items-center p-3 rounded-lg transition-colors" data-tool="text-to-image">
                    <i data-lucide="paintbrush-2" class="w-5 h-5 mr-3"></i>
                    Teks ke Gambar
                </a>
                 <a href="#" class="sidebar-link flex items-center p-3 rounded-lg transition-colors" data-tool="storyboard-director">
                    <i data-lucide="clapperboard" class="w-5 h-5 mr-3"></i>
                    Sutradara Storyboard
                </a>
                <a href="#" class="sidebar-link flex items-center p-3 rounded-lg transition-colors" data-tool="bg-remover">
                    <i data-lucide="eraser" class="w-5 h-5 mr-3"></i>
                    Hapus Background
                </a>
                <a href="#" class="sidebar-link flex items-center p-3 rounded-lg transition-colors" data-tool="image-mixer">
                    <i data-lucide="layers-3" class="w-5 h-5 mr-3"></i>
                    Penggabung Gambar
                </a>
                <a href="#" class="sidebar-link flex items-center p-3 rounded-lg transition-colors" data-tool="model-styler">
                    <i data-lucide="user-round" class="w-5 h-5 mr-3"></i>
                    Ubah Gaya Model
                </a>

                 <a href="#" class="sidebar-link flex items-center p-3 rounded-lg transition-colors" data-tool="ugc-generator">
                    <i data-lucide="camera" class="w-5 h-5 mr-3"></i>
                    UGC Konten Generator
                </a>

                 <a href="#" class="sidebar-link flex items-center p-3 rounded-lg transition-colors" data-tool="hashtag-planner">
                    <i data-lucide="hash" class="w-5 h-5 mr-3"></i>
                    Perencana Hashtag
                </a>
                <a href="#" class="sidebar-link flex items-center p-3 rounded-lg transition-colors" data-tool="script-generator">
                    <i data-lucide="file-text" class="w-5 h-5 mr-3"></i>
                    Buat Naskah Promo
                </a>
                <a href="#" class="sidebar-link flex items-center p-3 rounded-lg transition-colors" data-tool="text-to-speech">
                    <i data-lucide="audio-lines" class="w-5 h-5 mr-3"></i>
                    Teks ke Suara
                </a>
                <a href="#" class="sidebar-link flex items-center p-3 rounded-lg transition-colors" data-tool="video-analysis">
                    <i data-lucide="film" class="w-5 h-5 mr-3"></i>
                    Gambar ke Prompt Video
                </a>
                <hr class="my-2" style="border-color: var(--border-color);">
                <a href="#" class="sidebar-link flex items-center p-3 rounded-lg transition-colors" data-tool="features-functions">
                    <i data-lucide="book-open" class="w-5 h-5 mr-3"></i>
                    Fitur & Fungsi
                </a>
            </div>
            <div class="mt-auto text-center text-xs pt-10" style="color: var(--text-secondary);">
                <!-- Konten dihapus sesuai permintaan -->
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 p-4 sm:p-8 overflow-y-auto">
            <!-- Tool: Image to Prompt -->
            <div id="image-to-prompt" class="tool-card active">
                <h2 class="text-3xl font-bold mb-1 text-white">Gambar ke Prompt</h2>
                <p class="mb-6" style="color: var(--text-secondary);">Unggah gambar produk untuk mendapatkan prompt gambar siap pakai dalam format JSON.</p>
                <div class="p-6 rounded-lg shadow-lg"> <!-- Removed bg-gray-800 -->
                    <div id="drop-zone-1" class="drop-zone mb-4">
                        <p>Seret & lepas gambar di sini, atau klik untuk memilih file</p>
                        <input type="file" id="file-input-1" class="hidden" accept="image/*">
                        <img id="preview-1" class="hidden mt-4 max-h-48 mx-auto rounded-lg" />
                    </div>
                    <button id="generate-prompt-btn" class="w-full btn btn-primary font-bold py-3 px-4 rounded-lg transition-colors disabled:opacity-50" disabled>
                        Buat Prompt
                    </button>
                    <div id="loader-1" class="hidden mx-auto mt-6 loader"></div>
                    <div id="output-1" class="mt-6 hidden">
                         <pre id="json-output-container"><code></code></pre>
                         <button id="copy-prompt-btn" class="mt-4 btn btn-secondary font-bold py-2 px-4 rounded-lg flex items-center gap-2">
                             <i data-lucide="copy" class="w-4 h-4"></i> Salin JSON
                        </button>
                    </div>
                </div>
            </div>

             <!-- Tool: Image to Image Style -->
            <div id="image-to-image-style" class="tool-card">
                <h2 class="text-3xl font-bold mb-1 text-white">Gambar ke Gambar (Ubah Gaya)</h2>
                <p class="mb-6" style="color: var(--text-secondary);">Unggah gambar, beri instruksi, pilih gaya & rasio untuk 4 variasi baru dengan wajah yang sama.</p>
                <div class="p-6 rounded-lg shadow-lg"> <!-- Removed bg-gray-800 -->
                     <div class="grid grid-cols-1 md:grid-cols-2 gap-6 items-start">
                         <!-- Left Column: Input -->
                         <div class="space-y-6">
                            <div id="drop-zone-10" class="drop-zone">
                                <p>Seret & lepas gambar di sini, atau klik untuk memilih file</p>
                                <input type="file" id="file-input-10" class="hidden" accept="image/*">
                                <img id="preview-10" class="hidden mt-4 max-h-60 mx-auto rounded-lg" />
                            </div>
                            <div>
                                <label for="prompt-10" class="block text-sm font-medium mb-1" style="color: var(--text-primary);">Instruksi / Prompt Tambahan:</label>
                                <textarea id="prompt-10" class="form-textarea w-full rounded-md p-3 h-24" placeholder="Contoh: 'ganti background jadi hutan fantasi', 'tambahkan kacamata hitam', 'buat tersenyum lebar'"></textarea>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label for="style-10" class="block text-sm font-medium mb-1" style="color: var(--text-primary);">Gaya Visual:</label>
                                    <select id="style-10" class="form-select w-full rounded-md">
                                        <option value="photorealistic cinematic, 8k, detailed">Fotorealistis</option>
                                        <option value="watercolor painting, vibrant, artistic">Lukisan Cat Air</option>
                                        <option value="digital painting, fantasy art, epic">Lukisan Digital</option>
                                        <option value="pencil sketch, monochrome, detailed lines">Sketsa Pensil</option>
                                        <option value="3d animation, pixar style, vibrant colors">Animasi 3D</option>
                                        <option value="anime, manga style, studio ghibli aesthetic">Anime/Manga</option>
                                        <option value="cartoon, comic book style, bold outlines">Kartun/Komik</option>
                                        <option value="impressionism painting, soft brush strokes">Impresionisme</option>
                                    </select>
                                </div>
                                 <div>
                                    <label for="mood-10" class="block text-sm font-medium mb-1" style="color: var(--text-primary);">Suasana:</label>
                                    <select id="mood-10" class="form-select w-full rounded-md">
                                        <option value="neutral mood">Netral</option>
                                        <option value="cheerful, happy, bright atmosphere">Ceria / Bahagia</option>
                                        <option value="mysterious, dark, enigmatic">Misterius</option>
                                        <option value="dramatic, intense lighting, serious">Dramatis</option>
                                        <option value="calm, serene, peaceful environment">Tenang / Damai</option>
                                        <option value="energetic, dynamic, vibrant">Enerjik</option>
                                        <option value="sad, melancholic, somber tones">Sedih / Melankolis</option>
                                        <option value="futuristic, neon lights, cyberpunk">Futuristik</option>
                                    </select>
                                </div>
                            </div>
                             <div>
                                <label class="block text-sm font-medium mb-1" style="color: var(--text-primary);">Aspek Rasio:</label>
                                <div id="aspect-ratio-selector-10" class="grid grid-cols-3 gap-2">
                                    <button type="button" class="aspect-ratio-btn rounded-md py-2" data-value="1:1">1:1</button>
                                    <button type="button" class="aspect-ratio-btn rounded-md py-2 active" data-value="9:16">9:16</button>
                                    <button type="button" class="aspect-ratio-btn rounded-md py-2" data-value="16:9">16:9</button>
                                    <button type="button" class="aspect-ratio-btn rounded-md py-2" data-value="4:3">4:3</button>
                                    <button type="button" class="aspect-ratio-btn rounded-md py-2" data-value="3:4">3:4</button>
                                    <button type="button" class="aspect-ratio-btn rounded-md py-2" data-value="4:5">4:5</button>
                                </div>
                            </div>
                            <div class="flex items-center gap-4">
                                <button id="generate-style-btn-10" class="w-full btn btn-primary font-bold py-3 px-4 rounded-lg disabled:opacity-50" disabled>
                                    Buat 4 Variasi Gambar
                                </button>
                                <div id="loader-10" class="hidden loader"></div> <!-- Loader moved next to button -->
                             </div>
                         </div>
                         <!-- Right Column: Output -->
                          <div class="w-full min-h-[32rem] rounded-xl flex items-center justify-center p-4 relative" style="background-color: var(--bg-primary); border: 1px solid var(--border-color);">
                            <!-- Placeholder Awal -->
                            <div id="placeholder-10" class="text-center" style="color: var(--text-secondary);">
                                <i data-lucide="image" class="w-12 h-12 mx-auto mb-2"></i>
                                <p>Hasil akan muncul di sini.</p>
                            </div>
                            <!-- Pesan Error -->
                            <div id="error-10" class="hidden text-center text-red-400 p-4"></div>
                            <!-- Grid untuk Hasil Gambar -->
                            <div id="output-10" class="hidden w-full grid grid-cols-2 gap-4 items-start">
                                <!-- Images/Placeholders will be populated here -->
                            </div>
                        </div>
                     </div>
                </div>
            </div>

            <!-- Tool: Text to Image -->
            <div id="text-to-image" class="tool-card">
                 <h2 class="text-3xl font-bold mb-1 text-white">Generator Teks ke Gambar</h2>
                <p class="mb-6" style="color: var(--text-secondary);">Buat hingga 4 gambar dari deskripsi Anda dengan rasio aspek pilihan.</p>
                <div class="p-6 rounded-lg shadow-lg"> <!-- Removed bg-gray-800 -->
                     <!-- Form Input -->
                    <div class="flex flex-col sm:flex-row gap-3 mb-6">
                        <textarea id="promptInput-2" placeholder="Contoh: Potret seluruh badan seorang ksatria dengan baju zirah..." class="flex-grow w-full form-textarea rounded-lg transition" rows="3"></textarea> <!-- Updated classes -->
                        <select id="aspectRatio-2" class="form-select block w-full sm:w-auto transition"> <!-- Updated classes -->
                            <option value="9:16" selected>Potret (9:16)</option>
                            <option value="16:9">Lanskap (16:9)</option>
                            <option value="1:1">Persegi (1:1)</option>
                            <option value="4:3">Klasik (4:3)</option>
                        </select>
                        <button id="generateBtn-2" class="btn btn-primary font-semibold py-3 px-6 rounded-lg transition duration-300 ease-in-out transform hover:scale-105 flex items-center justify-center"> <!-- Updated classes -->
                            <i data-lucide="wand-2" class="w-5 h-5 mr-2"></i>
                            Buat
                        </button>
                    </div>

                    <!-- Wadah untuk menampilkan hasil, loading, atau placeholder -->
                    <div class="w-full min-h-[32rem] rounded-xl flex items-center justify-center p-4 relative" style="background-color: var(--bg-primary); border: 1px solid var(--border-color);"> <!-- Updated classes -->
                        <!-- Indikator Loading (Centered) -->
                        <div id="loadingIndicator-2" class="absolute inset-0 hidden flex-col items-center justify-center z-10" style="background-color: rgba(17, 17, 17, 0.75); color: var(--text-secondary);"> <!-- Updated classes -->
                            <div class="custom-loader mb-4"></div>
                            <p>Sedang membuat gambar (bisa memakan waktu)...</p>
                        </div>
                        <!-- Placeholder Awal -->
                        <div id="placeholder-2" class="text-center" style="color: var(--text-secondary);">
                            <i data-lucide="image" class="w-12 h-12 mx-auto mb-2"></i>
                            <p>Gambar yang dihasilkan akan muncul di sini.</p>
                        </div>
                        <!-- Pesan Error -->
                        <div id="errorMessage-2" class="hidden text-center text-red-400 p-4"></div>
                        <!-- Grid untuk Hasil Gambar -->
                        <div id="resultGrid-2" class="hidden w-full grid grid-cols-2 lg:grid-cols-4 gap-4 items-start">
                            <!-- Gambar akan dimasukkan di sini oleh JavaScript -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tool: Storyboard Director -->
            <div id="storyboard-director" class="tool-card">
                 <div class="mx-auto max-w-7xl">
                    <header class="text-center mb-8">
                        <h1 class="text-3xl md:text-4xl font-bold text-white">Sutradara Storyboard AI</h1>
                        <p class="text-lg mt-2" style="color: var(--text-secondary);">Alat Produksi Visual Multi-Modal Profesional.</p>
                    </header>

                    <!-- Setup Container -->
                    <div id="sb-setup-container" class="max-w-3xl mx-auto p-6 md:p-8 rounded-lg shadow-2xl" style="background-color: var(--bg-secondary); border: 1px solid var(--border-color);">
                        <form id="sb-story-form">
                            <div class="space-y-6">
                                <!-- Judul Cerita -->
                                <div>
                                    <label for="sb-story-title" class="block text-lg font-medium mb-2" style="color: var(--text-primary);">1. Judul Cerita</label>
                                    <input type="text" id="sb-story-title" class="sb-form-input w-full rounded-md p-3 text-lg" placeholder="Contoh: Sang Penjaga Hutan Kristal" required>
                                </div>

                                <!-- Deskripsi & Referensi Karakter -->
                                <div>
                                    <label for="sb-character-description" class="block text-lg font-medium mb-2" style="color: var(--text-primary);">2. Karakter Utama</label>
                                    <textarea id="sb-character-description" rows="3" class="sb-form-input w-full rounded-md p-3" placeholder="Deskripsikan karakter Anda di sini..."></textarea>

                                    <div class="mt-4">
                                        <p class="text-sm mb-2" style="color: var(--text-secondary);">Unggah gambar referensi (Opsional, Maks. 3):</p>
                                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                                            <!-- Model 1 -->
                                            <div class="sb-image-upload-container">
                                                <label for="sb-image-upload-1" class="sb-image-upload-box w-full h-32 rounded-lg flex items-center justify-center cursor-pointer text-center p-2">
                                                    <div id="sb-upload-prompt-1"><span class="block font-semibold">Model 1</span><span class="block text-xs" style="color: var(--text-secondary);">Klik untuk memilih</span></div>
                                                </label>
                                                <input type="file" id="sb-image-upload-1" class="hidden" accept="image/*" data-index="0">
                                                <div id="sb-image-preview-container-1" class="hidden mt-2 sb-image-preview-container"><img id="sb-image-preview-1" class="w-full h-32 object-cover rounded-lg" alt="Preview Model 1"><button type="button" class="sb-remove-image-btn p-1" data-index="0"><svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path></svg></button></div>
                                            </div>
                                            <!-- Model 2 -->
                                            <div class="sb-image-upload-container">
                                                 <label for="sb-image-upload-2" class="sb-image-upload-box w-full h-32 rounded-lg flex items-center justify-center cursor-pointer text-center p-2">
                                                    <div id="sb-upload-prompt-2"><span class="block font-semibold">Model 2</span><span class="block text-xs" style="color: var(--text-secondary);">Klik untuk memilih</span></div>
                                                </label>
                                                <input type="file" id="sb-image-upload-2" class="hidden" accept="image/*" data-index="1">
                                                <div id="sb-image-preview-container-2" class="hidden mt-2 sb-image-preview-container"><img id="sb-image-preview-2" class="w-full h-32 object-cover rounded-lg" alt="Preview Model 2"><button type="button" class="sb-remove-image-btn p-1" data-index="1"><svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path></svg></button></div>
                                            </div>
                                            <!-- Model 3 -->
                                            <div class="sb-image-upload-container">
                                                 <label for="sb-image-upload-3" class="sb-image-upload-box w-full h-32 rounded-lg flex items-center justify-center cursor-pointer text-center p-2">
                                                    <div id="sb-upload-prompt-3"><span class="block font-semibold">Model 3</span><span class="block text-xs" style="color: var(--text-secondary);">Klik untuk memilih</span></div>
                                                </label>
                                                <input type="file" id="sb-image-upload-3" class="hidden" accept="image/*" data-index="2">
                                                <div id="sb-image-preview-container-3" class="hidden mt-2 sb-image-preview-container"><img id="sb-image-preview-3" class="w-full h-32 object-cover rounded-lg" alt="Preview Model 3"><button type="button" class="sb-remove-image-btn p-1" data-index="2"><svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path></svg></button></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Gaya, Adegan, Rasio -->
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 pt-4" style="border-top: 1px solid var(--border-color);">
                                    <div>
                                       <label for="sb-visual-style" class="block text-lg font-medium mb-2" style="color: var(--text-primary);">3. Gaya Visual</label>
                                       <select id="sb-visual-style" class="sb-form-select w-full rounded-md">
                                           <option value="photorealistic cinematic, 8k, detailed">Fotorealistis Sinematik</option>
                                           <option value="3d animation, pixar style, vibrant colors">Animasi 3D (Gaya Pixar)</option>
                                           <option value="anime, manga style, studio ghibli aesthetic">Anime / Manga (Gaya Ghibli)</option>
                                           <option value="cartoon, comic book style, bold outlines">Gaya Kartun / Komik</option>
                                           <option value="digital painting, fantasy art, epic">Lukisan Digital (Fantasi)</option>
                                       </select>
                                    </div>
                                     <div>
                                        <label for="sb-scene-count" class="block text-lg font-medium mb-2" style="color: var(--text-primary);">4. Jumlah Adegan</label>
                                        <input type="number" id="sb-scene-count" class="sb-form-input w-full rounded-md p-3" value="12" min="1" required>
                                        <p id="sb-scene-warning" class="text-xs text-amber-400 mt-2 hidden">Jumlah adegan tinggi akan memakan waktu proses yang sangat lama.</p>
                                    </div>
                                    <div class="md:col-span-2">
                                       <label class="block text-lg font-medium mb-2" style="color: var(--text-primary);">5. Aspek Rasio</label>
                                       <div id="sb-aspect-ratio-selector" class="grid grid-cols-2 md:grid-cols-3 gap-2 p-1 rounded-lg" style="background-color: var(--bg-primary);">
                                           <button type="button" class="sb-aspect-ratio-btn rounded-md py-2 active" data-value="16:9">Lebar (16:9)</button>
                                           <button type="button" class="sb-aspect-ratio-btn rounded-md py-2" data-value="2.39:1">Sinematik (2.39:1)</button>
                                           <button type="button" class="sb-aspect-ratio-btn rounded-md py-2" data-value="1:1">Persegi (1:1)</button>
                                           <button type="button" class="sb-aspect-ratio-btn rounded-md py-2" data-value="4:3">Klasik (4:3)</button>
                                           <button type="button" class="sb-aspect-ratio-btn rounded-md py-2" data-value="9:16">Potret (9:16)</button>
                                           <button type="button" class="sb-aspect-ratio-btn rounded-md py-2" data-value="4:5">Sosial (4:5)</button>
                                       </div>
                                    </div>
                                </div>
                            </div>
                            <button type="submit" id="sb-generate-btn" class="mt-8 w-full sb-btn-primary font-bold py-3 px-4 rounded-lg text-lg flex items-center justify-center">
                                Buat Storyboard
                            </button>
                        </form>
                    </div>

                    <div id="sb-progress-container" class="hidden text-center max-w-3xl mx-auto mt-8">
                        <h2 id="sb-status-text" class="text-2xl font-semibold mb-4 text-white">Menganalisis...</h2>
                        <div class="w-full rounded-full h-4 mb-4 overflow-hidden" style="background-color: var(--bg-tertiary);"><div id="sb-progress-bar-fill" class="h-4 rounded-full" style="width: 0%; background-color: var(--accent-primary);"></div></div>
                        <p id="sb-progress-label" style="color: var(--text-secondary);">0 / 0</p>
                    </div>
                    <div id="sb-character-sheet-container" class="hidden max-w-3xl mx-auto mt-8 p-6 rounded-lg shadow-lg" style="background-color: var(--bg-tertiary); border: 1px solid var(--border-color);">
                        <h3 class="text-xl font-bold mb-3" style="color: var(--accent-primary);">Character Sheet (Hasil Analisis AI)</h3>
                        <p id="sb-character-sheet-content" style="color: var(--text-primary);"></p>
                    </div>
                    <div id="sb-main-output" class="mt-8">
                        <div id="sb-controls-container" class="hidden text-center mb-6"><button id="sb-restart-btn" class="sb-btn-secondary font-bold py-2 px-6 rounded-lg">Buat Cerita Baru</button></div>
                        <div id="sb-storyboard-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6"></div>
                    </div>
                </div>
            </div>

            <!-- Tool: Background Remover -->
            <div id="bg-remover" class="tool-card">
                 <h2 class="text-3xl font-bold mb-1 text-white">Hapus & Ganti Background</h2>
                <p class="mb-6" style="color: var(--text-secondary);">Unggah gambar produk, pilih kategori, dapatkan 8 variasi background, dan pilih rasio aspek.</p>
                 <div class="p-6 rounded-lg shadow-lg"> <!-- Removed bg-gray-800 -->
                    <div id="drop-zone-3" class="drop-zone mb-4">
                        <p>Seret & lepas gambar di sini, atau klik untuk memilih file</p>
                        <input type="file" id="file-input-3" class="hidden" accept="image/*">
                        <img id="preview-3" class="hidden mt-4 max-h-48 mx-auto rounded-lg" />
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                         <div>
                            <label for="aspect-ratio-3" class="block mb-2 text-sm font-medium" style="color: var(--text-primary);">Pilih Rasio Aspek:</label>
                            <select id="aspect-ratio-3" class="form-select block w-full"> <!-- Updated class -->
                                <option value="9:16" selected>Potret (9:16)</option>
                                <option value="16:9">Lanskap (16:9)</option>
                                <option value="1:1">Persegi (1:1)</option>
                                <option value="4:3">Klasik (4:3)</option>
                            </select>
                        </div>
                        <div>
                            <label for="category-select-3" class="block mb-2 text-sm font-medium" style="color: var(--text-primary);">Pilih Kategori Produk:</label>
                            <select id="category-select-3" class="form-select block w-full"> <!-- Updated class -->
                                <option value="skincare">Skincare & Kecantikan</option>
                                <option value="makanan">Makanan & Minuman</option>
                                <option value="fashion">Fashion & Aksesoris</option>
                                <option value="teknologi">Teknologi & Gadget</option>
                                <option value="mainan">Mainan & Anak</option>
                                <option value="otomotif">Otomotif</option>
                                <option value="rumahtangga">Rumah Tangga</option>
                                <option value="alam">Umum / Alam</option>
                            </select>
                        </div>
                         <!-- Add Custom BG input -->
                        <div class="md:col-span-2">
                            <label for="custom-bg-3" class="block mb-2 text-sm font-medium" style="color: var(--text-primary);">Atau masukkan background kustom:</label>
                            <input type="text" id="custom-bg-3" class="form-input w-full" placeholder="Contoh: 'di studio foto putih bersih', 'di pantai saat senja'">
                            <p class="text-xs mt-1" style="color: var(--text-secondary);">Jika diisi, ini akan menggantikan pilihan kategori di atas.</p>
                        </div>
                    </div>
                    <button id="remove-bg-btn" class="w-full btn btn-primary font-bold py-3 px-4 rounded-lg transition-colors disabled:opacity-50" disabled> <!-- Updated class -->
                        Buat 8 Variasi Background
                    </button>
                    <div id="loader-3" class="hidden mx-auto mt-6 custom-loader"></div>
                    <div id="output-3" class="mt-6 grid grid-cols-2 md:grid-cols-4 gap-4 hidden">
                        <!-- Images will be populated here -->
                    </div>
                </div>
            </div>

            <!-- Tool: AI Image Mixer -->
            <div id="image-mixer" class="tool-card">
                 <h2 class="text-3xl font-bold mb-1 text-white">Penggabung Gambar AI üñºÔ∏è</h2>
                <p class="mb-6" style="color: var(--text-secondary);">Gabungkan gambar model dan produk dengan instruksi spesifik Anda untuk menciptakan adegan baru.</p>
                <div class="p-6 rounded-lg shadow-lg"> <!-- Removed bg-gray-800 -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-4">
                        <div>
                            <label class="font-semibold mb-2 block">1. Unggah Gambar Model/Subjek</label>
                            <div id="drop-zone-4a" class="drop-zone">
                                <p>Seret atau klik untuk unggah model</p>
                                <input type="file" id="file-input-4a" class="hidden" accept="image/*">
                                <img id="preview-4a" class="hidden mt-4 max-h-48 mx-auto rounded-lg" />
                            </div>
                        </div>
                        <div>
                            <label class="font-semibold mb-2 block">2. Unggah Gambar Produk/Objek</label>
                            <div id="drop-zone-4b" class="drop-zone">
                                <p>Seret atau klik untuk unggah produk</p>
                                <input type="file" id="file-input-4b" class="hidden" accept="image/*">
                                <img id="preview-4b" class="hidden mt-4 max-h-48 mx-auto rounded-lg" />
                            </div>
                        </div>
                    </div>
                     <div class="mb-4">
                         <label for="prompt-4" class="font-semibold mb-2 block">3. Berikan Instruksi Anda</label>
                        <textarea id="prompt-4" class="form-textarea w-full rounded-lg h-24" placeholder="Jelaskan apa yang harus dilakukan model dengan produk..."></textarea> <!-- Updated class -->
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label for="aspect-ratio-4" class="block mb-2 text-sm font-medium" style="color: var(--text-primary);">Pilih Rasio Aspek:</label>
                            <select id="aspect-ratio-4" class="form-select block w-full"> <!-- Updated class -->
                                <option value="9:16" selected>Potret (9:16)</option>
                                <option value="16:9">Lanskap (16:9)</option>
                                <option value="1:1">Persegi (1:1)</option>
                                <option value="4:3">Klasik (4:3)</option>
                            </select>
                        </div>
                        <div>
                            <label for="background-4" class="block mb-2 text-sm font-medium" style="color: var(--text-primary);">Pilih Background:</label>
                            <select id="background-4" class="form-select block w-full"> <!-- Updated class -->
                                <option value="acak">Acak</option>
                                <option value="studio putih bersih">Studio Putih Bersih</option>
                                <optgroup label="Luar Ruangan">
                                    <option value="di jalanan kota yang ramai dengan butik fashion">Jalanan Kota</option>
                                    <option value="di taman bunga yang indah saat musim semi">Taman Bunga</option>
                                    <option value="di pantai berpasir putih dengan laut biru">Pantai</option>
                                    <option value="di depan kafe Eropa yang klasik">Kafe Eropa</option>
                                    <option value="di atap gedung dengan pemandangan kota saat senja">Atap Gedung (Senja)</option>
                                </optgroup>
                                <optgroup label="Dalam Ruangan">
                                    <option value="di dalam loft industrial dengan dinding bata">Loft Industrial</option>
                                    <option value="di dalam butik mewah dengan interior modern">Butik Mewah</option>
                                    <option value="di depan latar belakang berwarna pastel minimalis">Latar Pastel</option>
                                    <option value="di dalam ruang tamu yang elegan dan nyaman">Ruang Tamu Elegan</option>
                                </optgroup>
                            </select>
                        </div>
                        <!-- Add Custom BG input -->
                        <div class="md:col-span-2">
                             <label for="custom-bg-4" class="block mb-2 text-sm font-medium" style="color: var(--text-primary);">Atau masukkan background kustom:</label>
                            <input type="text" id="custom-bg-4" class="form-input w-full" placeholder="Contoh: 'di dalam kafe yang ramai', 'di atap gedung saat senja'">
                            <p class="text-xs mt-1" style="color: var(--text-secondary);">Jika diisi, ini akan menggantikan pilihan background di atas.</p>
                        </div>
                    </div>
                    <button id="mixer-btn" class="w-full btn btn-primary font-bold py-3 px-4 rounded-lg transition-colors disabled:opacity-50" disabled> <!-- Updated class -->
                        Buat 4 Variasi
                    </button>
                    <div id="loader-4" class="hidden mx-auto mt-6 custom-loader"></div>
                    <div id="output-4" class="mt-6 grid grid-cols-2 md:grid-cols-4 gap-4 hidden">
                        <!-- Images will be populated here -->
                    </div>
                </div>
            </div>

            <!-- Tool: Model Styler -->
            <div id="model-styler" class="tool-card">
                 <h2 class="text-3xl font-bold mb-1 text-white">Ubah Gaya Model</h2>
                <p class="mb-6" style="color: var(--text-secondary);">Unggah satu foto model untuk dibuatkan 8 angle berbeda dengan wajah yang sama.</p>
                 <div class="p-6 rounded-lg shadow-lg"> <!-- Removed bg-gray-800 -->
                    <div id="drop-zone-8" class="drop-zone mb-4">
                        <p>Seret & lepas gambar model di sini, atau klik untuk memilih file</p>
                        <input type="file" id="file-input-8" class="hidden" accept="image/*">
                        <img id="preview-8" class="hidden mt-4 max-h-48 mx-auto rounded-lg" />
                    </div>
                     <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                             <label for="aspect-ratio-8" class="block mb-2 text-sm font-medium" style="color: var(--text-primary);">Pilih Rasio Aspek:</label>
                             <select id="aspect-ratio-8" class="form-select block w-full"> <!-- Updated class -->
                                <option value="9:16" selected>Potret (9:16)</option>
                                <option value="16:9">Lanskap (16:9)</option>
                                <option value="1:1">Persegi (1:1)</option>
                                <option value="4:3">Klasik (4:3)</option>
                            </select>
                        </div>
                        <div>
                            <label for="background-8" class="block mb-2 text-sm font-medium" style="color: var(--text-primary);">Pilih Background:</label>
                            <select id="background-8" class="form-select block w-full"> <!-- Updated class -->
                                <option value="acak">Acak</option>
                                <option value="transparan">Transparan</option>
                                <optgroup label="Dalam Ruangan">
                                    <option value="di dalam ruangan kantor modern">Kantor Modern</option>
                                    <option value="di dalam kafe yang nyaman">Kafe Nyaman</option>
                                    <option value="di dalam perpustakaan klasik">Perpustakaan Klasik</option>
                                    <option value="di dalam studio foto putih bersih">Studio Foto Putih</option>
                                    <option value="di dalam ruang tamu mewah">Ruang Tamu Mewah</option>
                                </optgroup>
                                <optgroup label="Otomotif">
                                    <option value="di dalam mobil sport mewah">Mobil Sport</option>
                                    <option value="di samping mobil klasik di jalanan kota">Mobil Klasik</option>
                                </optgroup>
                                <optgroup label="Luar Ruangan">
                                    <option value="di jalanan kota Tokyo pada malam hari">Jalanan Kota Malam</option>
                                    <option value="di atap gedung dengan pemandangan kota">Atap Gedung</option>
                                    <option value="di pantai saat matahari terbenam">Pantai Senja</option>
                                    <option value="di tengah hutan pinus yang sejuk">Hutan Pinus</option>
                                    <option value="di puncak gunung dengan pemandangan awan">Puncak Gunung</option>
                                </optgroup>
                            </select>
                        </div>
                        <!-- Add Custom BG input -->
                        <div class="md:col-span-2">
                             <label for="custom-bg-8" class="block mb-2 text-sm font-medium" style="color: var(--text-primary);">Atau masukkan background kustom:</label>
                            <input type="text" id="custom-bg-8" class="form-input w-full" placeholder="Contoh: 'di jalanan kota Tokyo malam hari', 'di studio minimalis'">
                            <p class="text-xs mt-1" style="color: var(--text-secondary);">Jika diisi, ini akan menggantikan pilihan background di atas.</p>
                        </div>
                    </div>
                    <button id="generate-styler-btn" class="w-full btn btn-primary font-bold py-3 px-4 rounded-lg transition-colors disabled:opacity-50" disabled> <!-- Updated class -->
                        Buat 8 Variasi Gaya
                    </button>
                    <div id="loader-8" class="hidden mx-auto mt-6 custom-loader"></div>
                    <div id="output-8" class="mt-6 grid grid-cols-2 md:grid-cols-4 gap-4 hidden">
                        <!-- Images will be populated here -->
                    </div>
                </div>
            </div>

            <!-- Tool: UGC Konten Generator (BARU) -->
            <div id="ugc-generator" class="tool-card">
                <h2 class="text-3xl font-bold mb-1 text-white">UGC Konten Generator</h2>
                <p class="mb-6" style="color: var(--text-secondary);">Buat konten produk otomatis dengan gaya, model, dan rasio yang Anda inginkan.</p>
                <div class="p-6 rounded-lg shadow-lg space-y-6">
                    
                    <!-- Step 1: Upload Produk & Kategori -->
                    <div class="space-y-4">
                        <label class="block text-lg font-medium text-white">Langkah 1: Unggah Produk & Pilih Kategori</label>
                        <p class="text-sm" style="color: var(--text-secondary);">Unggah produk Anda, lalu pilih kategori yang paling sesuai.</p>
                        <div id="drop-zone-11" class="drop-zone">
                            <p>Seret & lepas gambar produk di sini, atau klik untuk memilih file</p>
                            <input type="file" id="file-input-11" class="hidden" accept="image/*">
                            <img id="preview-11" class="hidden mt-4 max-h-48 mx-auto rounded-lg" />
                        </div>
                        <select id="category-select-11" class="form-select w-full" disabled>
                            <option value="">Pilih kategori produk...</option>
                            <option value="fashion-top">Fashion (Atasan/Bawahan)</option>
                            <option value="fashion-shoes">Sepatu</option>
                            <option value="product-packaged">Produk Kemasan (Skincare, Makanan)</option>
                            <option value="product-furniture">Furnitur / Peralatan Rumah</option>
                            <option value="product-other">Lainnya</option>
                        </select>
                    </div>

                    <!-- Step 2: Pilihan Gaya Konten -->
                    <div id="style-section-11" class="space-y-4 hidden">
                        <label for="style-select-11" class="block text-lg font-medium text-white">Langkah 2: Pilih Gaya Konten</label>
                        <select id="style-select-11" class="form-select w-full">
                            <!-- Opsi akan diisi oleh JS -->
                        </select>
                    </div>

                    <!-- BARU: Langkah 3: Preset Tone Warna -->
                    <div id="tone-section-11" class="space-y-4 hidden">
                        <label for="tone-select-11" class="block text-lg font-medium text-white">Langkah 3: Pilih Tone Warna (Aestetic)</label>
                        <select id="tone-select-11" class="form-select w-full">
                            <option value="natural, realistic colors, clear lighting">Natural / Realistis (Default)</option>
                            <option value="warm tones, soft focus, golden hour light, dreamy aesthetic, soft shadows">Pinterest Aestetic (Warm & Dreamy)</option>
                            <option value="cool tones, moody lighting, cinematic, slightly desaturated, deep shadows">Pinterest Aestetic (Cool & Moody)</option>
                            <option value="bright and airy, high exposure, soft pastels, clean look, minimal shadows">Bright & Airy (Clean)</option>
                            <option value="vintage film look, grainy, faded colors, nostalgic feel, sepia tones">Vintage / Retro Film</option>
                            <option value="vibrant and saturated colors, high contrast, energetic, sharp details">Vibrant & Jelas</option>
                        </select>
                    </div>
                    <!-- AKHIR BARU -->

                    <!-- BARU: Opsi Model (Gender & Etnis) -->
                    <div id="model-options-11" class="space-y-4 hidden"> <!-- Muncul saat gaya model dipilih -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="model-gender-11" class="block text-sm font-medium mb-1" style="color: var(--text-primary);">Pilih Gender Model:</label>
                                <select id="model-gender-11" class="form-select w-full">
                                    <option value="bebas">Bebas / Tidak Spesifik</option>
                                    <option value="pria">Pria</option>
                                    <option value="wanita">Wanita</option>
                                </select>
                            </div>
                            <div>
                                <label for="model-etnis-11" class="block text-sm font-medium mb-1" style="color: var(--text-primary);">Pilih Etnis Model:</label>
                                <select id="model-etnis-11" class="form-select w-full">
                                    <option value="bebas">Bebas / Acak</option>
                                    <option value="indonesia">Indonesia</option>
                                    <option value="korea">Korea</option>
                                    <option value="jepang">Jepang</option>
                                    <option value="tiongkok">Tiongkok</option>
                                    <option value="amerika-kaukasia">Amerika (Kaukasia)</option>
                                    <option value="amerika-afrika">Amerika (Afrika)</option>
                                    <option value="eropa">Eropa</option>
                                    <option value="timur-tengah">Timur Tengah</option>
                                    <option value="india">India</option>
                                    <option value="latin">Latin</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <!-- AKHIR BARU -->

                    <!-- Step 3: Referensi Model (Opsional) -->
                    <div id="model-section-11" class="space-y-4 hidden">
                        <label class="block text-lg font-medium text-white">
                            Langkah 4: Referensi Wajah Model 
                            <span class="text-sm font-normal" style="color: var(--text-secondary);">(Opsional)</span>
                        </label>
                        <div id="drop-zone-12" class="drop-zone !p-4"> <!-- !p-4 to make it smaller -->
                            <p>Unggah foto referensi model (opsional)</p>
                            <input type="file" id="file-input-12" class="hidden" accept="image/jpeg, image/png, image/jpg">
                            <img id="preview-12" class="hidden mt-4 max-h-32 mx-auto rounded-lg" />
                        </div>
                    </div>

                    <!-- Step 4: Rasio Gambar -->
                    <div id="ratio-section-11" class="space-y-4 hidden">
                        <label for="aspect-ratio-11" class="block text-lg font-medium text-white">Langkah 5: Pilih Rasio Gambar</label>
                        <p class="text-sm" style="color: var(--text-secondary);">Sesuaikan rasio dengan kebutuhan platform Anda.</p>
                        <select id="aspect-ratio-11" class="form-select w-full">
                            <option value="9:16">9:16 (Story / Reels / TikTok)</option>
                            <option value="4:5">4:5 (Portrait Feed)</option>
                            <option value="1:1" selected>1:1 (Square / Instagram Feed)</option>
                            <option value="16:9">16:9 (YouTube Thumbnail)</option>
                        </select>
                    </div>

                    <!-- Tombol Generate -->
                    <button id="generate-ugc-btn" class="w-full btn btn-primary font-bold py-3 px-4 rounded-lg transition-colors disabled:opacity-50" disabled>
                        Buat 8 Variasi Konten
                    </button>

                    <!-- Output -->
                    <div id="loader-11" class="hidden mx-auto mt-6 custom-loader"></div>
                    <div id="output-11" class="mt-6 grid grid-cols-2 md:grid-cols-4 gap-4 hidden">
                        <!-- Hasil gambar akan muncul di sini -->
                    </div>

                </div>
            </div>

            <!-- Tool: AI Hashtag Planner -->
            <div id="hashtag-planner" class="tool-card">
                 <h2 class="text-3xl font-bold mb-1 text-white">Perencana Hashtag AI ‚ú®</h2>
                <p class="mb-6" style="color: var(--text-secondary);">Dapatkan strategi hashtag yang terstruktur untuk memaksimalkan jangkauan video Anda.</p>
                <div class="p-6 rounded-lg shadow-lg"> <!-- Removed bg-gray-800 -->
                    <textarea id="topic-input-9" class="form-textarea w-full rounded-lg mb-4 h-24" placeholder="Masukkan topik video atau niche produk Anda..."></textarea> <!-- Updated class -->
                    <button id="generate-hashtag-btn" class="w-full btn btn-primary font-bold py-3 px-4 rounded-lg transition-colors disabled:opacity-50" disabled> <!-- Updated class -->
                        Buat Strategi Hashtag
                    </button>
                    <div id="loader-9" class="hidden mx-auto mt-6 custom-loader"></div>
                    <div id="output-9" class="mt-6 p-4 rounded-lg hidden" style="background-color: var(--bg-primary); border: 1px solid var(--border-color);"> <!-- Updated class -->
                        <div class="space-y-4">
                            <div>
                                <h4 class="font-bold" style="color: var(--accent-primary);">#Ô∏è‚É£ Hashtag Utama</h4> <!-- Updated color -->
                                <div id="primary-hashtags-output" class="flex flex-wrap gap-2 text-sm"></div>
                            </div>
                            <div>
                                <h4 class="font-bold" style="color: var(--accent-primary);">üåê Hashtag Luas</h4> <!-- Updated color -->
                                <div id="broad-hashtags-output" class="flex flex-wrap gap-2 text-sm"></div>
                            </div>
                            <div>
                                <h4 class="font-bold" style="color: var(--accent-primary);">üìà Hashtag Tren</h4> <!-- Updated color -->
                                <div id="trending-hashtags-output" class="flex flex-wrap gap-2 text-sm"></div>
                            </div>
                            <div>
                                <h4 class="font-bold" style="color: var(--accent-primary);">üéØ Hashtag Audiens</h4> <!-- Updated color -->
                                <div id="audience-hashtags-output" class="flex flex-wrap gap-2 text-sm"></div>
                            </div>
                             <div>
                                <h4 class="font-bold" style="color: var(--accent-primary);">üí° Penjelasan Strategi</h4> <!-- Updated color -->
                                <p style="color: var(--text-primary);"></p>
                            </div>
                        </div>
                        <div class="mt-6">
                             <button id="copy-hashtags-btn" class="w-full btn btn-secondary font-bold py-2 px-4 rounded-lg flex items-center justify-center gap-2"> <!-- Updated class -->
                                <i data-lucide="copy" class="w-4 h-4"></i> Salin Semua Hashtag
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tool: Script Generator -->
            <div id="script-generator" class="tool-card">
                 <h2 class="text-3xl font-bold mb-1 text-white">Pembuat Naskah Promosi</h2>
                <p class="mb-6" style="color: var(--text-secondary);">Buat naskah video TikTok dengan struktur HOOK, MASALAH, SOLUSI, CTA.</p>
                <div class="p-6 rounded-lg shadow-lg"> <!-- Removed bg-gray-800 -->
                    <div id="script-inputs">
                        <input type="text" id="product-name-5" class="form-input w-full rounded-lg mb-4" placeholder="Nama Produk"> <!-- Updated class -->
                        <textarea id="product-desc-5" class="form-textarea w-full rounded-lg mb-4 h-24" placeholder="Deskripsi Singkat Produk"></textarea> <!-- Updated class -->
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                            <select id="style-5" class="form-select w-full rounded-lg"> <!-- Updated class -->
                                <option value="gaul">Gaya Bahasa: Gaul</option>
                                <option value="profesional">Gaya Bahasa: Profesional</option>
                                <option value="informatif">Gaya Bahasa: Informatif</option>
                                <option value="lucu">Gaya Bahasa: Lucu & Menghibur</option>
                            </select>
                             <select id="audience-5" class="form-select w-full rounded-lg"> <!-- Updated class -->
                                <option value="anak muda (Gen Z)">Target: Anak Muda (Gen Z)</option>
                                <option value="wanita dewasa">Target: Wanita Dewasa</option>
                                <option value="pria dewasa">Target: Pria Dewasa</option>
                                <option value="orang tua">Target: Orang Tua</option>
                                <option value="umum">Target: Umum</option>
                            </select>
                        </div>
                    </div>
                    <button id="generate-script-btn" class="w-full btn btn-primary font-bold py-3 px-4 rounded-lg transition-colors disabled:opacity-50" disabled> <!-- Updated class -->
                        Buat Naskah
                    </button>
                    <div id="loader-5" class="hidden mx-auto mt-6 custom-loader"></div>
                    <div id="output-5" class="mt-6 p-4 rounded-lg hidden" style="background-color: var(--bg-primary); border: 1px solid var(--border-color);"> <!-- Updated class -->
                        <div class="space-y-4">
                            <div>
                                <h4 class="font-bold" style="color: var(--accent-primary);">HOOK üé£</h4> <!-- Updated color -->
                                <p id="hook-output"></p>
                            </div>
                            <div>
                                <h4 class="font-bold" style="color: var(--accent-primary);">MASALAH üò•</h4> <!-- Updated color -->
                                <p id="problem-output"></p>
                            </div>
                            <div>
                                <h4 class="font-bold" style="color: var(--accent-primary);">SOLUSI ‚ú®</h4> <!-- Updated color -->
                                <p id="solution-output"></p>
                            </div>
                            <div>
                                <h4 class="font-bold" style="color: var(--accent-primary);">CTA üõí</h4> <!-- Updated color -->
                                <p id="cta-output"></p>
                            </div>
                             <div>
                                <h4 class="font-bold" style="color: var(--accent-primary);">CAPTION ‚úçÔ∏è</h4> <!-- Updated color -->
                                <p id="caption-output"></p>
                            </div>
                             <div>
                                <h4 class="font-bold" style="color: var(--accent-primary);">HASHTAGS #Ô∏è‚É£</h4> <!-- Updated color -->
                                <div id="hashtags-output" class="flex flex-wrap gap-2 text-sm" style="color: var(--accent-hover);"></div> <!-- Updated color -->
                            </div>
                        </div>
                        <div class="mt-6 flex flex-col sm:flex-row gap-2">
                             <button id="copy-script-btn" class="w-full sm:w-auto flex-grow btn btn-secondary font-bold py-2 px-4 rounded-lg flex items-center justify-center gap-2"> <!-- Updated class -->
                                <i data-lucide="copy" class="w-4 h-4"></i> Salin Naskah
                            </button>
                            <button id="regenerate-script-btn" class="w-full sm:w-auto flex-grow btn btn-primary font-bold py-2 px-4 rounded-lg flex items-center justify-center gap-2"> <!-- Updated class -->
                                 <i data-lucide="rotate-cw" class="w-4 h-4"></i> Buat Ulang
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tool: Text to Speech -->
            <div id="text-to-speech" class="tool-card">
                 <h2 class="text-3xl font-bold mb-1 text-white">Teks ke Suara (AI Voiceover)</h2>
                <p class="mb-6" style="color: var(--text-secondary);">Ubah naskah promosi Anda menjadi narasi suara yang natural.</p>
                <div class="p-6 rounded-lg shadow-lg"> <!-- Removed bg-gray-800 -->
                    <textarea id="tts-input-6" class="form-textarea w-full rounded-lg mb-4 h-48" placeholder="Masukkan atau tempel naskah promosi di sini..."></textarea> <!-- Updated class -->
                     <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                        <select id="style-select-6" class="form-select w-full rounded-lg"> <!-- Updated class -->
                            <option value="ceria dan enerjik">Gaya: Ceria</option>
                            <option value="sedih dan melankolis">Gaya: Sedih</option>
                            <option value="lucu dan jenaka">Gaya: Lucu</option>
                            <option value="profesional dan informatif">Gaya: Profesional</option>
                            <option value="berbisik dan misterius">Gaya: Berbisik</option>
                            <option value="tenang dan santai">Gaya: Santai</option>
                            <option value="emosional">Gaya: Emosional</option>
                        </select>
                        <select id="voice-select-6" class="form-select w-full rounded-lg"> <!-- Updated class -->
                            <!-- All voices will be populated by JS -->
                        </select>
                    </div>
                    <button id="generate-audio-btn" class="w-full btn btn-primary font-bold py-3 px-4 rounded-lg transition-colors disabled:opacity-50" disabled> <!-- Updated class -->
                        Buat Audio
                    </button>
                    <div id="loader-6" class="hidden mx-auto mt-6 custom-loader"></div>
                    <div id="output-6" class="mt-6 hidden">
                        <audio controls class="w-full">
                            <source id="audio-source" src="" type="audio/wav">
                            Browser Anda tidak mendukung elemen audio.
                        </audio>
                        <a id="download-audio-btn" href="#" download="ai-voiceover.wav" class="mt-4 inline-flex items-center justify-center w-full btn btn-secondary font-bold py-3 px-4 rounded-lg transition-colors"> <!-- Updated class -->
                            <i data-lucide="download" class="w-5 h-5 mr-2"></i>
                            Unduh Audio
                        </a>
                    </div>
                </div>
            </div>

            <!-- Tool: Video Analysis -->
            <div id="video-analysis" class="tool-card">
                 <h2 class="text-3xl font-bold mb-1 text-white">Gambar ke Prompt Video (Pro)</h2>
                <p class="mb-6" style="color: var(--text-secondary);">Unggah gambar untuk dianalisis AI, dan dapatkan prompt video Veo 3 yang sangat realistis, lengkap dengan negative prompt.</p>
                <div class="p-6 rounded-lg shadow-lg"> <!-- Removed bg-gray-800 -->
                     <!-- Input Section -->
                    <div class="grid md:grid-cols-2 gap-8 items-start">
                        <div class="flex flex-col items-center justify-center w-full">
                            <label for="image-upload-7" class="flex flex-col items-center justify-center w-full h-64 border-2 border-dashed rounded-lg cursor-pointer transition-colors drop-zone"> <!-- Updated class -->
                                <div class="flex flex-col items-center justify-center pt-5 pb-6">
                                    <i data-lucide="upload-cloud" class="w-10 h-10 mb-4" style="color: var(--text-secondary);"></i>
                                    <p class="mb-2 text-sm" style="color: var(--text-secondary);"><span class="font-semibold" style="color: var(--text-primary);">Klik untuk mengunggah</span> atau seret dan lepas</p>
                                    <p class="text-xs" style="color: var(--text-secondary);">PNG, JPG, atau WEBP</p>
                                </div>
                                <input id="image-upload-7" type="file" class="hidden" accept="image/png, image/jpeg, image/webp" />
                            </label>
                            <div id="image-preview-container-7" class="mt-4 w-full h-64 rounded-lg flex items-center justify-center hidden" style="background-color: var(--bg-primary); border: 1px solid var(--border-color);"> <!-- Updated class -->
                                 <p id="image-placeholder-7" style="color: var(--text-secondary);">Pratinjau Gambar</p>
                                <img id="image-preview-7" src="" alt="Pratinjau Gambar" class="max-w-full max-h-full rounded-lg hidden">
                            </div>
                             <div class="mt-6 w-full flex flex-col sm:flex-row gap-4">
                                <button id="analyze-button-7" class="w-full flex-grow btn btn-primary font-semibold py-3 px-6 rounded-lg transition-all duration-300 flex items-center justify-center gap-2 disabled:opacity-50" disabled> <!-- Updated class -->
                                    <i data-lucide="scan-eye" class="w-5 h-5"></i>
                                    Buat Prompt Video
                                </button>
                                <button id="clear-button-7" class="w-full sm:w-auto btn btn-secondary font-semibold py-3 px-4 rounded-lg flex items-center justify-center gap-2 hidden"> <!-- Updated class -->
                                    <i data-lucide="x" class="w-5 h-5"></i>
                                    Ganti
                                </button>
                            </div>
                        </div>

                     <!-- BARU: Panduan UGC Generator -->
                     <!-- BLOK INI DIHAPUS SESUAI PERMINTAAN -->
                     <!-- AKHIR BARU -->

                     <!-- DIUBAH: Panel statis di kanan diganti dengan kontrol input dinamis -->
                     <div class="p-6 rounded-lg shadow-lg space-y-4" style="background-color: var(--bg-secondary); border: 1px solid var(--border-color);">
                        <h3 class="text-2xl font-bold mb-3 flex items-center" style="color: var(--accent-primary);"><i data-lucide="settings-2" class="w-6 h-6 mr-3"></i>Kontrol Prompt Veo 3</h3>
                        
                        <!-- Fitur 5 & 10: Preset Gaya -->
                        <div>
                            <label for="veo-preset-7" class="block text-sm font-medium mb-1" style="color: var(--text-primary);">1. Preset Gaya (Veo 3)</label>
                            <select id="veo-preset-7" class="form-select w-full rounded-md">
                                <option value="cinematic">Sinematik (Realistis)</option>
                                <option value="documentary">Dokumenter (Natural)</option>
                                <option value="vlog">Gaya Vlog (Handheld)</option>
                                <option value="music-video">Video Musik (Stylish)</option>
                                <option value="fantasy">Fantasi / Sureal</option>
                                <option value="action">Adegan Aksi (Dinamis)</option>
                            </select>
                        </div>

                        <!-- Fitur 3: Konteks Gerakan -->
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div>
                                <label for="veo-camera-7" class="block text-sm font-medium mb-1" style="color: var(--text-primary);">2. Gerakan Kamera</label>
                                <select id="veo-camera-7" class="form-select w-full rounded-md">
                                    <option value="biarkan AI yang menentukan">Biarkan AI Menentukan</option>
                                    <option value="static shot">Statis (Diam)</option>
                                    <option value="slow pan left">Geser Lambat ke Kiri</option>
                                    <option value="slow pan right">Geser Lambat ke Kanan</option>
                                    <option value="slow zoom in">Zoom Masuk Lambat</option>
                                    <option value="slow zoom out">Zoom Keluar Lambat</option>
                                    <option value="handheld subtle motion">Genggam (Sedikit Goyang)</option>
                                    <option value="dolly shot forward">Dolly Maju</option>
                                </select>
                            </div>
                            <div>
                                <label for="veo-anim-7" class="block text-sm font-medium mb-1" style="color: var(--text-primary);">3. Animasi Alami</label>
                                <select id="veo-anim-7" class="form-select w-full rounded-md">
                                    <option value="subtle natural animation (e.g., wind, hair moving, water ripples)">Animasi Alami (Angin, Rambut)</option>
                                    <option value="dynamic animation (e.g., leaves falling, sparks)">Animasi Dinamis (Daun, Api)</option>
                                    <option value="none">Tidak Ada</option>
                                </select>
                            </div>
                        </div>
                         <div>
                            <label for="veo-action-7" class="block text-sm font-medium mb-1" style="color: var(--text-primary);">4. Aksi Karakter (Opsional)</label>
                            <input type="text" id="veo-action-7" class="form-input w-full" placeholder="Contoh: 'tersenyum ke kamera', 'berjalan maju'">
                        </div>

                        <!-- Fitur 4: Dialog -->
                        <div>
                            <label for="veo-dialogue-7" class="block text-sm font-medium mb-1" style="color: var(--text-primary);">5. Dialog / Voice Line (Opsional)</label>
                            <textarea id="veo-dialogue-7" class="form-textarea w-full rounded-md p-3 h-20" placeholder="Contoh: 'Ayo kita mulai perjalanannya...'"></textarea>
                        </div>
                     </div>
                 </div>

                 <!-- BARU: Bagian Loader dan Output ditambahkan kembali -->
                 <div id="loader-7" class="hidden mx-auto mt-8 custom-loader"></div>
                 <div id="results-container-7" class="mt-8 hidden">
                     <h3 class="text-2xl font-bold mb-4 text-white">Hasil Prompt Veo 3</h3>
                     <div class="p-4 rounded-lg shadow-lg" style="background-color: var(--bg-secondary); border: 1px solid var(--border-color);">
                         <!-- DIUBAH: dari <pre> menjadi <textarea> untuk teks biasa -->
                         <textarea id="text-output-7" class="form-textarea w-full rounded-md" rows="15" readonly style="color: var(--text-primary); background-color: var(--bg-primary); border-color: var(--border-color);"></textarea>
                         <button id="copy-prompt-7" class="mt-4 w-full sm:w-auto btn btn-secondary font-bold py-2 px-4 rounded-lg flex items-center justify-center gap-2">
                             <i data-lucide="copy" class="w-4 h-4"></i> Salin Prompt
                         </button>
                     </div>
                 </div>

            </div>

        </main>
    </div>

    <div id="toast" class="toast">Teks disalin!</div>

    <!-- Modal Edit Gambar (BARU) -->
    <div id="editModal" class="fixed inset-0 z-50 hidden" style="background-color: rgba(0,0,0,0.7);">
        <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-full max-w-4xl p-4">
            <div class="rounded-lg shadow-2xl p-6" style="background-color: var(--bg-secondary); border: 1px solid var(--border-color);">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-2xl font-bold text-white">Edit Gambar</h3>
                    <button id="edit-modal-close-btn" class="p-1 rounded-full" style="color: var(--text-secondary); background-color: var(--bg-tertiary);">
                        <i data-lucide="x" class="w-6 h-6"></i>
                    </button>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Kolom Kiri: Gambar Asli & Prompt -->
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium mb-1" style="color: var(--text-primary);">Gambar Asli:</label>
                            <img id="edit-modal-preview" src="" alt="Gambar Asli" class="rounded-lg w-full object-contain max-h-64" style="background-color: var(--bg-primary);">
                        </div>
                        <div>
                            <label for="edit-modal-prompt" class="block text-sm font-medium mb-1" style="color: var(--text-primary);">Instruksi Edit:</label>
                            <textarea id="edit-modal-prompt" rows="3" class="form-textarea w-full rounded-lg" placeholder="Contoh: 'ganti warna bajunya jadi merah', 'tambahkan topi koboi'"></textarea>
                        </div>
                        
                        <!-- BARU: Pilihan Aspek Rasio -->
                        <!-- DIHAPUS: Dropdown aspek rasio dihapus karena tidak didukung oleh model edit -->
                        <!--
                        <div>
                            <label for="edit-modal-aspect-ratio" class="block text-sm font-medium mb-1" style="color: var(--text-primary);">Aspek Rasio Baru:</label>
                            <select id="edit-modal-aspect-ratio" class="form-select w-full rounded-lg">
                                <option value="9:16">Potret (9:16)</option>
                                <option value="16:9">Lanskap (16:9)</option>
                                <option value="1:1">Persegi (1:1)</option>
                                <option value="4:3">Klasik (4:3)</option>
                            </select>
                        </div>
                        -->
                        <!-- AKHIR BARU -->

                        <button id="edit-modal-generate-btn" class="w-full btn btn-primary font-bold py-3 px-4 rounded-lg flex items-center justify-center gap-2">
                            <i data-lucide="wand-2" class="w-5 h-5"></i>
                            Buat Versi Edit
                        </button>
                    </div>
                    
                    <!-- Kolom Kanan: Hasil Edit -->
                    <div class="space-y-4">
                        <label class="block text-sm font-medium mb-1" style="color: var(--text-primary);">Hasil Edit:</label>
                        <div id="edit-modal-output-container" class="w-full min-h-64 flex items-center justify-center rounded-lg" style="background-color: var(--bg-primary); border: 1px solid var(--border-color);">
                            <!-- Loader -->
                            <div id="edit-modal-loader" class="hidden custom-loader"></div>
                            <!-- Placeholder -->
                            <div id="edit-modal-placeholder" class="text-center" style="color: var(--text-secondary);">
                                <i data-lucide="image-down" class="w-10 h-10 mx-auto mb-2"></i>
                                <p>Hasil editan akan muncul di sini.</p>
                            </div>
                            <!-- Gambar Hasil -->
                            <img id="edit-modal-new-image" src="" alt="Hasil Edit" class="rounded-lg w-full object-contain max-h-64 hidden">
                        </div>
                        <button id="edit-modal-replace-btn" class="w-full btn btn-secondary font-bold py-3 px-4 rounded-lg hidden flex items-center justify-center gap-2">
                            <i data-lucide="replace" class="w-5 h-5"></i>
                            Ganti Gambar Asli
                        </button>
                         <a id="edit-modal-download-btn" href="#" download="edited-image.png" class="w-full btn btn-secondary font-bold py-3 px-4 rounded-lg hidden items-center justify-center gap-2">
                            <i data-lucide="download" class="w-5 h-5"></i>
                            Unduh Gambar Ini
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- Initialize Lucide Icons ---
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            } else {
                console.error("Lucide library not loaded yet during DOMContentLoaded.");
                setTimeout(() => {
                    if (typeof lucide !== 'undefined') { lucide.createIcons(); }
                    else { console.error("Lucide library failed to load."); }
                }, 500);
            }


            // --- Responsive Mobile Menu Logic ---
            const sidebar = document.getElementById('sidebar');
            const mobileMenuButton = document.getElementById('mobile-menu-button');
            const closeMenuButton = document.getElementById('close-menu-button');
             if(mobileMenuButton && sidebar) mobileMenuButton.addEventListener('click', () => sidebar.classList.remove('-translate-x-full'));
             if(closeMenuButton && sidebar) closeMenuButton.addEventListener('click', () => sidebar.classList.add('-translate-x-full'));

            // --- Navigation Logic ---
            const sidebarLinks = document.querySelectorAll('.sidebar-link');
            const toolCards = document.querySelectorAll('.tool-card');
            sidebarLinks.forEach(link => {
                link.addEventListener('click', e => {
                    e.preventDefault();
                    let tool = link.dataset.tool;
                    if (tool === 'virtual-tryon') tool = 'image-mixer'; // Handle old link

                    const activeLink = document.querySelector(`.sidebar-link[data-tool='${tool}']`);
                    if (activeLink) {
                         sidebarLinks.forEach(l => l.classList.remove('active'));
                         activeLink.classList.add('active');
                    }

                    toolCards.forEach(card => card.classList.toggle('active', card.id === tool));

                    if (window.innerWidth < 768 && sidebar) sidebar.classList.add('-translate-x-full'); // Check sidebar exists
                    // No need to call lucide.createIcons() here again
                });
            });

            // --- Helper Functions ---
            const API_KEY = ""; // Kept empty as instructed
            const fileToBase64 = file => new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = error => reject(error);
            });

            const base64ToFile = (base64, filename, mimeType) => {
                const byteCharacters = atob(base64);
                const byteNumbers = new Array(byteCharacters.length);
                for (let i = 0; i < byteCharacters.length; i++) {
                    byteNumbers[i] = byteCharacters.charCodeAt(i);
                }
                const byteArray = new Uint8Array(byteNumbers);
                const blob = new Blob([byteArray], { type: mimeType });
                return new File([blob], filename, { type: mimeType });
            };

            const showLoader = (loaderId, buttonId) => {
                 const loader = document.getElementById(loaderId);
                 if (loader) loader.classList.remove('hidden');
                 const button = document.getElementById(buttonId);
                 if (button) button.disabled = true;
            };
            const hideLoader = (loaderId, buttonId) => {
                const loader = document.getElementById(loaderId);
                if (loader) loader.classList.add('hidden');
                const button = document.getElementById(buttonId);
                if (button) button.disabled = false;
            };

            const fallbackCopyTextToClipboard = (text, successCallback) => {
                const textArea = document.createElement("textarea");
                textArea.value = text;
                textArea.style.top = "0"; textArea.style.left = "0"; textArea.style.position = "fixed";
                document.body.appendChild(textArea);
                textArea.focus(); textArea.select();
                try {
                    if (document.execCommand('copy')) successCallback();
                } catch (err) { console.error('Fallback: Gagal menyalin', err); }
                document.body.removeChild(textArea);
            };

             const handleCopyClick = (button, textToCopy) => {
                if (!button) return; // Prevent error if button doesn't exist
                const showSuccess = () => {
                    const originalHtml = button.innerHTML;
                    button.innerHTML = '<i data-lucide="check" class="w-4 h-4"></i> Tersalin!';
                    if (typeof lucide !== 'undefined') lucide.createIcons();
                    setTimeout(() => {
                        button.innerHTML = originalHtml;
                        if (typeof lucide !== 'undefined') lucide.createIcons();
                    }, 2000);
                };
                fallbackCopyTextToClipboard(textToCopy, showSuccess);
            };


            const toastEl = document.getElementById('toast');
            const showToast = (message = "Teks disalin!") => { // Allow custom messages
                 if (!toastEl) return;
                 toastEl.textContent = message; // Set message
                 toastEl.classList.add('show');
                 setTimeout(() => { toastEl.classList.remove('show'); }, 2000);
            };

            // Modified to handle results consistently, using result-card style
            function createImageResultCard(base64Data, containerId, filename, aspectRatio) {
                const container = document.getElementById(containerId);
                if (!container) return; // Add check

                const card = document.createElement('div');
                // Use new theme classes
                card.className = 'result-card rounded-lg overflow-hidden shadow-lg flex flex-col'; // Removed space-y-2

                const img = document.createElement('img');
                const imageUrl = `data:image/png;base64,${base64Data}`;
                img.src = imageUrl;

                // Determine aspect ratio class based on input, default or map
                let aspectClass = 'aspect-square'; // Default 1:1
                const ratioMap = {
                    '9:16': 'aspect-[9/16]', '16:9': 'aspect-video', '4:3': 'aspect-[4/3]',
                    '1:1': 'aspect-square', '3:4': 'aspect-[3/4]', '4:5': 'aspect-[4/5]' // Added more ratios
                };
                if (ratioMap[aspectRatio]) {
                    aspectClass = ratioMap[aspectRatio];
                }

                // Apply aspect ratio and object-cover
                img.className = `w-full h-auto object-cover rounded-t-lg ${aspectClass}`; // Use h-auto with aspect class

                // Create a button container
                const controlsContainer = document.createElement('div');
                controlsContainer.className = 'grid grid-cols-2 gap-0'; // No gap

                const downloadLink = document.createElement('a');
                downloadLink.href = imageUrl;
                downloadLink.download = filename;
                // Use new theme classes, remove rounded-b-lg, add rounded-bl-lg
                downloadLink.className = 'flex items-center justify-center gap-2 w-full font-semibold py-2 px-3 rounded-bl-lg text-sm transition-colors';
                downloadLink.innerHTML = `<i data-lucide="download" class="w-4 h-4"></i><span>Unduh</span>`;

                // Create delete button
                const deleteButton = document.createElement('button');
                deleteButton.type = 'button';
                deleteButton.className = 'delete-btn flex items-center justify-center gap-2 w-full font-semibold py-2 px-3 rounded-br-lg text-sm'; // Use new class
                deleteButton.innerHTML = `<i data-lucide="trash-2" class="w-4 h-4"></i><span>Hapus</span>`;

                // Add click event
                deleteButton.addEventListener('click', () => {
                    card.style.transition = 'opacity 0.3s ease-out, transform 0.3s ease-out';
                    card.style.opacity = '0';
                    card.style.transform = 'scale(0.9)';
                    setTimeout(() => {
                        card.remove();
                    }, 300);
                });


                card.appendChild(img);
                controlsContainer.appendChild(downloadLink);
                controlsContainer.appendChild(deleteButton);
                card.appendChild(controlsContainer); // Add the container

                container.appendChild(card);
                if (typeof lucide !== 'undefined') lucide.createIcons();
            }

            // --- Variabel global baru untuk modal edit ---
            let activeEditCard = { cardElement: null, base64: null };

            // --- Simplified setupDropZone and handleFile (already present, ensured checks) ---
            function setupDropZone(dropZone, fileInput, preview, onFileSelect) {
                if (!dropZone || !fileInput || !preview) {
                    console.warn("setupDropZone: One or more elements not found for", fileInput?.id);
                    return;
                }
                dropZone.addEventListener('click', () => fileInput.click());
                dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('dragover'); });
                dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
                dropZone.addEventListener('drop', (e) => {
                    e.preventDefault(); dropZone.classList.remove('dragover');
                    const droppedFile = e.dataTransfer.files[0];
                    if (droppedFile?.type.startsWith('image/')) handleFile(droppedFile, fileInput, preview, onFileSelect);
                });
                fileInput.addEventListener('change', () => { if (fileInput.files[0]) handleFile(fileInput.files[0], fileInput, preview, onFileSelect); });
            }

            function handleFile(file, fileInput, preview, callback) {
                 if (!preview || !fileInput) {
                    console.warn("handleFile: Preview or Input element not found for", fileInput?.id);
                    return;
                }
                const dt = new DataTransfer(); dt.items.add(file); fileInput.files = dt.files;
                const reader = new FileReader();
                reader.onload = e => { preview.src = e.target.result; preview.classList.remove('hidden'); };
                reader.readAsDataURL(file);
                if (callback && typeof callback === 'function') { // Check if callback is a function
                   callback(file);
                }
            }


            // --- Tool 1: Image to Prompt ---
            const fileInput1 = document.getElementById('file-input-1');
            const generatePromptBtn = document.getElementById('generate-prompt-btn');
            const dropZone1 = document.getElementById('drop-zone-1');
            const preview1 = document.getElementById('preview-1');
            const output1 = document.getElementById('output-1');
            const copyPromptBtn = document.getElementById('copy-prompt-btn');
            let file1 = null, lastJsonPrompt1 = null;
            if(dropZone1 && fileInput1 && preview1 && generatePromptBtn) {
                 setupDropZone(dropZone1, fileInput1, preview1, (selectedFile) => {
                    file1 = selectedFile; generatePromptBtn.disabled = false;
                });
                 generatePromptBtn.addEventListener('click', async () => {
                       if (!file1 || !output1) return; // Add check for output1
                        showLoader('loader-1', 'generate-prompt-btn');
                        output1.classList.add('hidden');
                        try {
                            const base64Image = await fileToBase64(file1);
                            const prompt = `Analyze the product in the image. Act as an expert prompt engineer. Generate a JSON object containing three ready-to-use, detailed English prompts for an image generation AI (like Midjourney or DALL-E) to create similar high-quality product photos. The JSON should have three keys: "prompt_main", "prompt_angle", and "prompt_lifestyle".`;
                            const schema = { type: "OBJECT", properties: { "prompt_main": { "type": "STRING", "description": "A detailed main prompt focusing on the product's features and a neutral background." }, "prompt_angle": { "type": "STRING", "description": "A prompt describing the product from a dynamic angle." }, "prompt_lifestyle": { "type": "STRING", "description": "A prompt showing the product in a lifestyle or in-use context." } }, required: ["prompt_main", "prompt_angle", "prompt_lifestyle"] };
                            const payload = { contents: [{ parts: [{ text: prompt }, { inlineData: { mimeType: file1.type, data: base64Image } }] }], generationConfig: { responseMimeType: "application/json", responseSchema: schema } };
                            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${API_KEY}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                            const result = await response.json();
                            const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;
                            if (!jsonText) throw new Error("API response did not contain valid JSON text.");
                            const data = JSON.parse(jsonText);
                            lastJsonPrompt1 = data;
                            const codeElement = document.querySelector('#json-output-container code');
                            if (codeElement) codeElement.textContent = JSON.stringify(data, null, 2); // Check codeElement exists
                            output1.classList.remove('hidden');
                        } catch (error) {
                            console.error("Error:", error); alert("Terjadi kesalahan saat membuat prompt.");
                        } finally {
                            hideLoader('loader-1', 'generate-prompt-btn');
                        }
                 });
            } else { console.warn("Image to Prompt elements not fully found."); }
            if (copyPromptBtn) {
                copyPromptBtn.addEventListener('click', (e) => {
                    if (lastJsonPrompt1) handleCopyClick(e.currentTarget, JSON.stringify(lastJsonPrompt1, null, 2));
                });
            }


            // --- Tool 10: Image to Image Style (NEW) ---
            const fileInput10 = document.getElementById('file-input-10');
            const generateStyleBtn10 = document.getElementById('generate-style-btn-10');
            const dropZone10 = document.getElementById('drop-zone-10');
            const preview10 = document.getElementById('preview-10');
            const prompt10 = document.getElementById('prompt-10');
            const styleSelect10 = document.getElementById('style-10');
            const moodSelect10 = document.getElementById('mood-10');
            const aspectRatioSelector10 = document.getElementById('aspect-ratio-selector-10');
            const output10 = document.getElementById('output-10');
            const loader10 = document.getElementById('loader-10');
            const placeholder10 = document.getElementById('placeholder-10');
            const error10 = document.getElementById('error-10');
            let file10 = null;

            const ratioMap10 = { // Define this map for tool 10
                '9:16': 'aspect-[9/16]', '16:9': 'aspect-video', '4:3': 'aspect-[4/3]',
                '1:1': 'aspect-square', '3:4': 'aspect-[3/4]', '4:5': 'aspect-[4/5]'
            };

            const checkImageStyleReady = () => {
                if(generateStyleBtn10) generateStyleBtn10.disabled = !file10;
            };

            if (dropZone10 && fileInput10 && preview10 && generateStyleBtn10) {
                 setupDropZone(dropZone10, fileInput10, preview10, (selectedFile) => {
                    file10 = selectedFile;
                    checkImageStyleReady();
                });

                if (aspectRatioSelector10) {
                     aspectRatioSelector10.addEventListener('click', (e) => {
                        if (e.target.tagName === 'BUTTON' && e.target.classList.contains('aspect-ratio-btn')) {
                            aspectRatioSelector10.querySelectorAll('.aspect-ratio-btn').forEach(btn => btn.classList.remove('active'));
                            e.target.classList.add('active');
                        }
                    });
                }

                generateStyleBtn10.addEventListener('click', async () => {
                    if (!file10) return;
                    showLoader('loader-10', 'generate-style-btn-10'); // Shows loader next to button
                     if(placeholder10) placeholder10.classList.add('hidden');
                     if(error10) error10.classList.add('hidden');

                    const activeAspectBtn10 = aspectRatioSelector10 ? aspectRatioSelector10.querySelector('.aspect-ratio-btn.active') : null;
                    const aspectRatio = activeAspectBtn10 ? activeAspectBtn10.dataset.value : '9:16';
                    const aspectClass = ratioMap10[aspectRatio] || 'aspect-square';

                    // Show pulsing placeholders
                    if (output10) {
                        output10.innerHTML = ''; // Clear previous results
                        for (let i = 0; i < 4; i++) {
                            output10.innerHTML += `<div class="pulse-placeholder ${aspectClass}"></div>`;
                        }
                        output10.classList.remove('hidden');
                    }

                    const userPrompt = prompt10 ? prompt10.value.trim() : '';
                    const style = styleSelect10 ? styleSelect10.value : 'photorealistic';
                    const mood = moodSelect10 ? moodSelect10.value : 'neutral mood';

                    try {
                        const base64Image = await fileToBase64(file10);

                        const promises = Array(4).fill(0).map(async (_, index) => {
                            const combinedPrompt = `Based on the uploaded image, create a new image of the **SAME PERSON**, preserving their exact facial features and ethnicity. Apply the following style: "${style}" and mood: "${mood}". Additional instructions: "${userPrompt}". Final image aspect ratio must be ${aspectRatio}. Variation ${index+1}.`;
                            const payload = {
                                contents: [{
                                    parts: [ { text: combinedPrompt }, { inlineData: { mimeType: file10.type, data: base64Image } } ]
                                }],
                                generationConfig: { responseModalities: ['IMAGE'] }
                            };
                            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image-preview:generateContent?key=${API_KEY}`, {
                                method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload)
                            });
                            if (!response.ok) { console.error(`API Error for variation ${index+1}: ${response.status}`); return null; }
                            const result = await response.json();
                            const candidate = result?.candidates?.[0];
                            if (candidate?.finishReason !== "OK" && candidate?.finishReason !== "STOP") { console.warn(`Image generation ${index+1} stopped due to: ${candidate?.finishReason}`); return null; }
                            return candidate?.content?.parts?.find(p => p.inlineData)?.inlineData?.data;
                        });

                        const results = (await Promise.all(promises)).filter(data => data);

                        if (output10) output10.innerHTML = ''; // Clear pulsing placeholders

                        if (results.length > 0 && output10) {
                            results.forEach((base64Data, i) => {
                                createImageResultCard(base64Data, 'output-10', `styled-image-${i + 1}.png`, aspectRatio);
                            });
                            output10.classList.remove('hidden');
                        } else if (results.length === 0 && error10){
                            error10.textContent = "Gagal membuat variasi gambar. Filter keamanan mungkin aktif atau terjadi kesalahan lain. Coba gambar/prompt berbeda.";
                            error10.classList.remove('hidden');
                            if (output10) output10.classList.add('hidden');
                            if (placeholder10) placeholder10.classList.remove('hidden');
                        }
                    } catch (error) {
                        console.error("Error generating styled images:", error);
                        if(error10) { error10.textContent = `Terjadi kesalahan: ${error.message}`; error10.classList.remove('hidden'); }
                        if (output10) { output10.innerHTML = ''; output10.classList.add('hidden'); }
                        if (placeholder10) placeholder10.classList.remove('hidden');
                    } finally {
                        hideLoader('loader-10', 'generate-style-btn-10');
                    }
                });

            } else { console.warn("Image to Image Style elements not fully found."); }


            // --- Tool 2: Text to Image ---
            const promptInput2 = document.getElementById('promptInput-2');
            const generateBtn2 = document.getElementById('generateBtn-2');
            const aspectRatioSelect2 = document.getElementById('aspectRatio-2');
            const loadingIndicator2 = document.getElementById('loadingIndicator-2');
            const placeholder2 = document.getElementById('placeholder-2');
            const errorMessage2 = document.getElementById('errorMessage-2');
            const resultGrid2 = document.getElementById('resultGrid-2');
            const apiUrl2 = `https://generativelanguage.googleapis.com/v1beta/models/imagen-3.0-generate-002:predict?key=${API_KEY}`;
            
            const callApi2 = async () => {
                const prompt = promptInput2.value.trim();
                const aspectRatio = aspectRatioSelect2.value;
                if (!prompt) { showError2("Silakan masukkan deskripsi gambar."); return; }
                setLoadingState2(true);
                const payload = { instances: [{ prompt: prompt }], parameters: { sampleCount: 4, aspectRatio: aspectRatio } };
                const response = await fetch(apiUrl2, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status} ${response.statusText}`);
                const result = await response.json();
                if (result.predictions && result.predictions.length > 0) {
                    displayResults2(result.predictions);
                } else { throw new Error("Invalid API response or no image data received."); }
            };

            const generateImageWithBackoff2 = async (maxRetries = 3) => {
                let attempt = 0;
                while (attempt < maxRetries) {
                    try { await callApi2(); return; } catch (error) {
                        console.error(`Attempt ${attempt + 1} failed:`, error);
                        attempt++;
                        if (attempt >= maxRetries) { showError2("Gagal membuat gambar setelah beberapa kali percobaan. Silakan coba lagi nanti."); throw new Error("Max retries reached"); }
                        const delay = Math.pow(2, attempt) * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                    }
                }
            };

            function displayResults2(predictions) {
                if (!resultGrid2) return;
                resultGrid2.innerHTML = '';
                predictions.forEach((prediction, index) => {
                    if (prediction.bytesBase64Encoded) {
                        const imageDataUrl = `data:image/png;base64,${prediction.bytesBase64Encoded}`;
                        const card = document.createElement('div');
                        card.className = 'result-card relative group rounded-lg overflow-hidden shadow-md';
                        const img = document.createElement('img');
                        img.src = imageDataUrl;
                        img.alt = `Generated image ${index + 1}`;
                        const aspectRatio = aspectRatioSelect2 ? aspectRatioSelect2.value : '9:16';
                        let aspectClass = 'aspect-square';
                        const ratioMap = {'9:16': 'aspect-[9/16]', '16:9': 'aspect-video', '4:3': 'aspect-[4/3]', '1:1': 'aspect-square'};
                        if (ratioMap[aspectRatio]) aspectClass = ratioMap[aspectRatio];
                        img.className = `w-full h-auto object-cover transition-transform duration-300 group-hover:scale-105 rounded-t-lg ${aspectClass}`;
                        const downloadLink = document.createElement('a');
                        downloadLink.href = imageDataUrl;
                        downloadLink.download = `generated-image-${Date.now()}-${index + 1}.png`;
                        downloadLink.className = 'absolute top-2 right-2 bg-black bg-opacity-60 text-white p-2 rounded-full hover:bg-opacity-80 transition-opacity opacity-0 group-hover:opacity-100 focus:opacity-100';
                        downloadLink.innerHTML = `<i data-lucide="download" class="w-5 h-5"></i>`;
                        downloadLink.title = "Unduh gambar";

                        // NEW DELETE BUTTON
                        const deleteButton = document.createElement('button');
                        deleteButton.type = 'button';
                        deleteButton.className = 'absolute top-2 left-2 bg-black bg-opacity-60 text-white p-2 rounded-full hover:bg-red-600 hover:bg-opacity-100 transition-all opacity-0 group-hover:opacity-100 focus:opacity-100'; // Position left, hover red
                        deleteButton.innerHTML = `<i data-lucide="trash-2" class="w-5 h-5"></i>`;
                        deleteButton.title = "Hapus gambar";

                        deleteButton.addEventListener('click', () => {
                            card.style.transition = 'opacity 0.3s ease-out, transform 0.3s ease-out';
                            card.style.opacity = '0';
                            card.style.transform = 'scale(0.9)';
                            setTimeout(() => {
                                card.remove();
                            }, 300);
                        });
                        // END NEW

                        // --- TOMBOL EDIT BARU ---
                        const editButton = document.createElement('button');
                        editButton.type = 'button';
                        // Posisikan di sebelah tombol unduh
                        editButton.className = 'absolute top-2 right-12 bg-black bg-opacity-60 p-2 rounded-full hover:bg-opacity-100 transition-all opacity-0 group-hover:opacity-100 focus:opacity-100';
                        editButton.innerHTML = `<i data-lucide="pencil" class="w-5 h-5" style="color: var(--accent-primary);"></i>`; // Ikon kuning
                        editButton.title = "Edit gambar";

                        editButton.addEventListener('click', () => {
                            activeEditCard.cardElement = card; // Simpan elemen kartu
                            activeEditCard.base64 = prediction.bytesBase64Encoded; // Simpan base64

                            const editModal = document.getElementById('editModal');
                            const editModalPreview = document.getElementById('edit-modal-preview');
                            const editModalPrompt = document.getElementById('edit-modal-prompt');
                            const editModalNewImage = document.getElementById('edit-modal-new-image');
                            const editModalPlaceholder = document.getElementById('edit-modal-placeholder');
                            const editModalReplaceBtn = document.getElementById('edit-modal-replace-btn');
                            const editModalDownloadBtn = document.getElementById('edit-modal-download-btn');
                            const editModalLoader = document.getElementById('edit-modal-loader');

                            // Reset modal state
                            if (editModalPreview) editModalPreview.src = `data:image/png;base64,${activeEditCard.base64}`;
                            if (editModalPrompt) editModalPrompt.value = '';
                            if (editModalNewImage) {
                                editModalNewImage.src = '';
                                editModalNewImage.classList.add('hidden');
                            }
                            if(editModalPlaceholder) editModalPlaceholder.classList.remove('hidden');
                            if(editModalReplaceBtn) editModalReplaceBtn.classList.add('hidden');
                            if(editModalDownloadBtn) editModalDownloadBtn.classList.add('hidden');
                            if(editModalLoader) editModalLoader.classList.add('hidden');
                            
                            // --- BARU: Atur Aspek Rasio Pratinjau Modal ---
                            if (editModalPreview) {
                                // 1. Ambil kelas dari img asli (img sudah ada di scope displayResults2)
                                const originalClassName = img.className; 
                                
                                // 2. Tentukan kelas rasio yang baru
                                let aspectClass = 'aspect-square'; // Default
                                if (originalClassName.includes('aspect-[9/16]')) aspectClass = 'aspect-[9/16]';
                                else if (originalClassName.includes('aspect-video')) aspectClass = 'aspect-video';
                                else if (originalClassName.includes('aspect-[4/3]')) aspectClass = 'aspect-[4/3]';
                                
                                // 3. Hapus kelas lama dari pratinjau modal
                                editModalPreview.className = editModalPreview.className.replace(/aspect-\[.*?\]|aspect-video|aspect-square/g, '');
                                
                                // 4. Tambahkan kelas baru ke pratinjau modal
                                editModalPreview.classList.add(aspectClass);
                            }
                            // --- AKHIR BARU ---
                            
                            if(editModal) editModal.classList.remove('hidden');

                            // --- BARU: Pre-select aspect ratio dropdown ---
                            // DIHAPUS: Logika untuk mengatur dropdown rasio dihapus
                            /*
                            const editModalAspectRatio = document.getElementById('edit-modal-aspect-ratio');
                            if (editModalAspectRatio) {
                                const originalClassName = img.className; // 'img' is in scope here
...
                            }
                            */
                            // --- AKHIR BARU ---

                            if(typeof lucide !== 'undefined') lucide.createIcons(); // Inisialisasi ikon modal
                        });
                        // --- AKHIR TOMBOL EDIT BARU ---

                        // --- TOMBOL TAMBAH PRODUK BARU ---
                        const addProductButton = document.createElement('button');
                        addProductButton.type = 'button';
                        // Posisikan di sebelah tombol edit
                        addProductButton.className = 'absolute top-2 right-22 bg-black bg-opacity-60 p-2 rounded-full hover:bg-opacity-100 transition-all opacity-0 group-hover:opacity-100 focus:opacity-100';
                        addProductButton.innerHTML = `<i data-lucide="package-plus" class="w-5 h-5" style="color: var(--accent-primary);"></i>`; // Ikon kuning
                        addProductButton.title = "Tambah ke Penggabung";

                        addProductButton.addEventListener('click', () => {
                            const base64Data = prediction.bytesBase64Encoded;
                            const newFile = base64ToFile(base64Data, `generated-model-${Date.now()}.png`, 'image/png');

                            // Cari elemen untuk 'image-mixer' (Tool 4a)
                            const fileInput4a = document.getElementById('file-input-4a');
                            const preview4a = document.getElementById('preview-4a');
                            
                            if (fileInput4a && preview4a) {
                                // Gunakan handleFile yang ada untuk memuatnya
                                handleFile(newFile, fileInput4a, preview4a, (selectedFile) => {
                                    modelFile4 = selectedFile; // Ini adalah var global untuk tool 4
                                    checkMixerReady(); 
                                });
                                
                                // Pindahkan tab
                                const mixerLink = document.querySelector('.sidebar-link[data-tool="image-mixer"]');
                                if (mixerLink) {
                                    mixerLink.click(); // Ini akan memicu logika navigasi
                                }
                                
                                // Tampilkan toast
                                showToast("Gambar ditambahkan ke Penggabung!");

                                // Gulir ke tool
                                const mixerToolCard = document.getElementById('image-mixer');
                                if (mixerToolCard) {
                                    mixerToolCard.scrollIntoView({ behavior: 'smooth', block: 'start' });
                                }
                            } else {
                                console.error("Tidak dapat menemukan drop zone Penggabung Gambar.");
                                showToast("Error: Drop zone tidak ditemukan.");
                            }
                        });
                        // --- AKHIR TOMBOL TAMBAH PRODUK ---

                        card.appendChild(img); 
                        card.appendChild(downloadLink);
                        card.appendChild(deleteButton); // Add the delete button
                        card.appendChild(editButton); // Tambahkan tombol edit
                        card.appendChild(addProductButton); // Tambahkan tombol produk
                        resultGrid2.appendChild(card);
                    }
                });
                if (typeof lucide !== 'undefined') lucide.createIcons();
                setLoadingState2(false);
                resultGrid2.classList.remove('hidden');
            }

            function setLoadingState2(isLoading) {
                if(generateBtn2) generateBtn2.disabled = isLoading;
                if (isLoading) {
                    if(generateBtn2) generateBtn2.classList.add('opacity-50', 'cursor-not-allowed');
                    if(loadingIndicator2) loadingIndicator2.classList.remove('hidden');
                    if(placeholder2) placeholder2.classList.add('hidden');
                    if(errorMessage2) errorMessage2.classList.add('hidden');
                    if(resultGrid2) resultGrid2.classList.add('hidden');
                } else {
                    if(generateBtn2) generateBtn2.classList.remove('opacity-50', 'cursor-not-allowed');
                    if(loadingIndicator2) loadingIndicator2.classList.add('hidden');
                }
            }

            function showError2(message) {
                setLoadingState2(false);
                if(placeholder2) placeholder2.classList.add('hidden');
                if(resultGrid2) resultGrid2.classList.add('hidden');
                if(errorMessage2) { errorMessage2.textContent = message; errorMessage2.classList.remove('hidden'); }
            }

            if (generateBtn2) {
                 generateBtn2.addEventListener('click', () => {
                    generateImageWithBackoff2().catch(err => {
                        console.error("Failed to generate image after all retries:", err);
                    });
                });
            }


            // --- Tool 3: Background Remover ---
            const removeBgBtn = document.getElementById('remove-bg-btn');
            const output3 = document.getElementById('output-3');
            const categorySelect3 = document.getElementById('category-select-3');
            const customBg3 = document.getElementById('custom-bg-3');
            let file3 = null;
            const backgroundPrompts = {
                skincare: ["clean bathroom with marble countertop and soft light", "fresh green leaves with water droplets", "minimalist white podium with floral accents", "abstract splash of water with a pastel background", "a laboratory setting with clean glassware", "a flatlay on a soft pink silk fabric", "a sunlit vanity with a blurred plant", "a textured background of light-colored stone", "a podium floating on calm water"],
                makanan: ["rustic wooden kitchen table with fresh ingredients around", "a modern clean kitchen counter with a blurred background", "a picnic setting in a sunny park", "a dark slate background with dramatic lighting", "a professional restaurant kitchen in action", "a close-up of a sizzling pan", "a vibrant, colorful farmer's market stall", "a cozy cafe table next to a window", "a flatlay of spices and herbs on a dark surface"],
                fashion: ["minimalist studio with a single colored backdrop", "a chic urban street scene with bokeh lights", "a luxurious interior with a velvet armchair", "a sandy beach at golden hour", "an industrial loft with brick walls", "a background of elegant, flowing fabric", "a runway with bright spotlights", "in front of a classic architectural building", "a lush, green garden setting"],
                teknologi: ["a sleek, modern office desk with minimalist accessories", "an abstract background with glowing neon lines", "a close-up of a circuit board with depth of field", "a dark, textured surface with a single spotlight", "a futuristic cityscape at night", "a gradient background with cool tones (blue, purple)", "a server room with racks of equipment", "a person's hand interacting with a holographic display", "a clean, white workspace with a single plant"],
                mainan: ["a colorful and bright children's playroom", "a soft, fluffy carpet with building blocks scattered", "an outdoor park with green grass and a sunny sky", "a child's bedroom with drawings on the wall", "a magical, starry night sky background", "a wooden floor from a low angle perspective", "a background of colorful, abstract shapes", "a school classroom with a chalkboard", "a whimsical forest scene"],
                otomotif: ["an open road stretching into the horizon at sunset", "a modern, clean garage with professional lighting", "a winding mountain road with sharp turns", "a wet city street at night with neon reflections", "a professional race track with a blurred grandstand", "an industrial warehouse with moody lighting", "a desert landscape under a clear blue sky", "a high-end car showroom", "a close-up of carbon fiber texture"],
                rumahtangga: ["a cozy living room with a fireplace", "a modern, sunlit kitchen with white cabinets", "a clean bathroom with neatly folded towels", "on a minimalist wooden shelf against a white wall", "a beautifully set dining table", "a comfortable bed with plush pillows", "a home garden or patio with plants", "laundry room with natural light", "a neat home office setup"],
                alam: ["meja kayu minimalis", "kamar tidur estetik", "outdoor dengan cahaya natural", "setup studio putih", "dinding bata ekspos", "taman bunga yang blur", "latar belakang gradasi warna pastel", "permukaan marmer mewah", "kain sutra lembut"]
            };
            /* REMOVED createBgRemovedCard function, as it's no longer needed */

            if(document.getElementById('drop-zone-3') && document.getElementById('file-input-3') && document.getElementById('preview-3')) {
                setupDropZone(document.getElementById('drop-zone-3'), document.getElementById('file-input-3'), document.getElementById('preview-3'), (selectedFile) => { file3 = selectedFile; if(removeBgBtn) removeBgBtn.disabled = false; });
            }
            if (removeBgBtn) {
                 removeBgBtn.addEventListener('click', async () => {
                    if (!file3 || !output3 || !categorySelect3 || !customBg3) return;
                    showLoader('loader-3', 'remove-bg-btn');
                    output3.classList.add('hidden'); output3.innerHTML = '';
                    const aspectRatioInput = document.getElementById('aspect-ratio-3');
                    const aspectRatio = aspectRatioInput ? aspectRatioInput.value : '9:16';
                    const selectedCategory = categorySelect3.value;
                    const customBg = customBg3.value.trim(); // <-- Get custom BG

                    let backgrounds;
                    if (customBg) {
                        backgrounds = Array(8).fill(customBg); // <-- Use custom BG if provided
                    } else {
                        backgrounds = backgroundPrompts[selectedCategory] || backgroundPrompts['alam']; // <-- Use category if not
                    }

                    try {
                        const base64Image = await fileToBase64(file3);
                        const promises = backgrounds.slice(0, 8).map(async (bg) => {
                            const prompt = `Hapus background asli gambar produk yang diunggah. Beri background baru yaitu "${bg}". Rasio gambar ${aspectRatio}. Pastikan produk tetap jadi pusat perhatian, dengan pencahayaan natural dan profesional.`;
                            const payload = { contents: [{ parts: [{ text: prompt }, { inlineData: { mimeType: file3.type, data: base64Image } }] }], generationConfig: { responseModalities: ['IMAGE'] } };
                            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image-preview:generateContent?key=${API_KEY}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                            if (!response.ok) return null;
                            const result = await response.json();
                            const candidate = result?.candidates?.[0];
                            if (candidate?.finishReason === "SAFETY" || candidate?.finishReason === "RECITATION") { return null; }
                            return candidate?.content?.parts?.find(p => p.inlineData)?.inlineData?.data;
                        });
                        const results = (await Promise.all(promises)).filter(r => r);
                        if (results.length > 0) {
                            /* UPDATED: Manually create cards like displayResults2 */
                            results.forEach((base64Data, index) => {
                                const imageDataUrl = `data:image/png;base64,${base64Data}`;
                                const card = document.createElement('div');
                                card.className = 'result-card relative group rounded-lg overflow-hidden shadow-md'; // Same as displayResults2
                                const img = document.createElement('img');
                                img.src = imageDataUrl;
                                img.alt = `Generated image ${index + 1}`;
                                
                                let aspectClass = 'aspect-square';
                                const ratioMap = {'9:16': 'aspect-[9/16]', '16:9': 'aspect-video', '4:3': 'aspect-[4/3]', '1:1': 'aspect-square'};
                                if (ratioMap[aspectRatio]) aspectClass = ratioMap[aspectRatio];
                                img.className = `w-full h-auto object-cover transition-transform duration-300 group-hover:scale-105 rounded-lg ${aspectClass}`; // rounded-lg

                                const downloadLink = document.createElement('a');
                                downloadLink.href = imageDataUrl;
                                downloadLink.download = `product-bg-${Date.now()}-${index + 1}.png`;
                                downloadLink.className = 'absolute bottom-2 right-2 bg-black bg-opacity-60 text-white p-2 rounded-full hover:bg-opacity-80 transition-opacity opacity-0 group-hover:opacity-100 focus:opacity-100';
                                downloadLink.innerHTML = `<i data-lucide="download" class="w-5 h-5"></i>`;
                                downloadLink.title = "Unduh gambar";

                                const deleteButton = document.createElement('button');
                                deleteButton.type = 'button';
                                deleteButton.className = 'absolute bottom-2 left-2 bg-black bg-opacity-60 text-white p-2 rounded-full hover:bg-red-600 hover:bg-opacity-100 transition-all opacity-0 group-hover:opacity-100 focus:opacity-100';
                                deleteButton.innerHTML = `<i data-lucide="trash-2" class="w-5 h-5"></i>`;
                                deleteButton.title = "Hapus gambar";

                                deleteButton.addEventListener('click', () => {
                                    card.style.transition = 'opacity 0.3s ease-out, transform 0.3s ease-out';
                                    card.style.opacity = '0';
                                    card.style.transform = 'scale(0.9)';
                                    setTimeout(() => {
                                        card.remove();
                                    }, 300);
                                });

                                card.appendChild(img); 
                                card.appendChild(downloadLink);
                                card.appendChild(deleteButton);
                                if(output3) output3.appendChild(card);
                            });
                            if (typeof lucide !== 'undefined') lucide.createIcons();
                            /* END UPDATED BLOCK */
                            output3.classList.remove('hidden');
                        } else { throw new Error("Tidak ada gambar yang berhasil dibuat. Ini mungkin karena filter keamanan pada gambar asli Anda."); }
                    } catch (error) { console.error("Error:", error); alert(error.message || "Gagal menghapus background. Coba lagi.");
                    } finally { hideLoader('loader-3', 'remove-bg-btn'); }
                });
            }

            // --- Tool 4: AI Image Mixer ---
            const mixerBtn = document.getElementById('mixer-btn');
            const output4 = document.getElementById('output-4');
            const prompt4 = document.getElementById('prompt-4');
            const customBg4 = document.getElementById('custom-bg-4');
            const background4Select = document.getElementById('background-4');
            let modelFile4 = null, productFile4 = null;
            function createMixerCard(base64Data, containerId, filename, aspectRatio) {
                // Using the more generic createImageResultCard
                //  createImageResultCard(base64Data, containerId, filename, aspectRatio); // <-- GAYA LAMA DIHAPUS

                // GAYA BARU: Disalin dari displayResults2 (Teks ke Gambar) agar sama persis
                const container = document.getElementById(containerId);
                if (!container) return;

                const imageDataUrl = `data:image/png;base64,${base64Data}`;
                const card = document.createElement('div');
                // Kelas T2I: relative group, rounded-lg, overflow-hidden
                card.className = 'result-card relative group rounded-lg overflow-hidden shadow-md'; 
                
                const img = document.createElement('img');
                img.src = imageDataUrl;
                img.alt = filename; // Gunakan filename
                
                let aspectClass = 'aspect-square';
                // Peta rasio yang diperluas agar sesuai dengan semua alat
                const ratioMap = {
                    '9:16': 'aspect-[9/16]', '16:9': 'aspect-video', '4:3': 'aspect-[4/3]',
                    '1:1': 'aspect-square', '3:4': 'aspect-[3/4]', '4:5': 'aspect-[4/5]'
                };
                if (ratioMap[aspectRatio]) aspectClass = ratioMap[aspectRatio];
                
                // Kelas T2I: rounded-t-lg dan efek hover. (Meskipun 'rounded-t-lg' aneh, kita tiru agar sama)
                img.className = `w-full h-auto object-cover transition-transform duration-300 group-hover:scale-105 rounded-t-lg ${aspectClass}`;

                // Kelas T2I: Tombol Unduh (absolute, bottom-2, right-2, opacity-0, dll.)
                const downloadLink = document.createElement('a');
                downloadLink.href = imageDataUrl;
                downloadLink.download = filename;
                downloadLink.className = 'absolute top-2 right-2 bg-black bg-opacity-60 text-white p-2 rounded-full hover:bg-opacity-80 transition-opacity opacity-0 group-hover:opacity-100 focus:opacity-100'; // Diubah ke top-2 right-2
                downloadLink.innerHTML = `<i data-lucide="download" class="w-5 h-5"></i>`; // Hanya ikon
                downloadLink.title = "Unduh gambar";

                // Kelas T2I: Tombol Hapus (absolute, bottom-2, left-2, opacity-0, dll.)
                const deleteButton = document.createElement('button');
                deleteButton.type = 'button';
                deleteButton.className = 'absolute top-2 left-2 bg-black bg-opacity-60 text-white p-2 rounded-full hover:bg-red-600 hover:bg-opacity-100 transition-all opacity-0 group-hover:opacity-100 focus:opacity-100'; // Diubah ke top-2 left-2
                deleteButton.innerHTML = `<i data-lucide="trash-2" class="w-5 h-5"></i>`; // Hanya ikon
                deleteButton.title = "Hapus gambar";

                deleteButton.addEventListener('click', () => {
                    card.style.transition = 'opacity 0.3s ease-out, transform 0.3s ease-out';
                    card.style.opacity = '0';
                    card.style.transform = 'scale(0.9)';
                    setTimeout(() => {
                        card.remove();
                    }, 300);
                });

                // --- TOMBOL EDIT BARU (DITAMBAHKAN UNTUK MIXER) ---
                const editButton = document.createElement('button');
                editButton.type = 'button';
                // Posisikan di sebelah tombol unduh (seperti di Tool 2)
                editButton.className = 'absolute bottom-2 left-1/2 -translate-x-1/2 bg-black bg-opacity-60 p-2 rounded-full hover:bg-opacity-100 transition-all opacity-0 group-hover:opacity-100 focus:opacity-100'; // DIUBAH: Posisi ke bawah tengah
                editButton.innerHTML = `<i data-lucide="pencil" class="w-5 h-5" style="color: var(--accent-primary);"></i>`; // Ikon kuning
                editButton.title = "Edit gambar";

                editButton.addEventListener('click', () => {
                    activeEditCard.cardElement = card; // Simpan elemen kartu
                    activeEditCard.base64 = base64Data; // Simpan base64 (dari parameter fungsi)

                    const editModal = document.getElementById('editModal');
                    const editModalPreview = document.getElementById('edit-modal-preview');
                    const editModalPrompt = document.getElementById('edit-modal-prompt');
                    const editModalNewImage = document.getElementById('edit-modal-new-image');
                    const editModalPlaceholder = document.getElementById('edit-modal-placeholder');
                    const editModalReplaceBtn = document.getElementById('edit-modal-replace-btn');
                    const editModalDownloadBtn = document.getElementById('edit-modal-download-btn');
                    const editModalLoader = document.getElementById('edit-modal-loader');

                    // Reset modal state
                    if (editModalPreview) editModalPreview.src = `data:image/png;base64,${activeEditCard.base64}`;
                    if (editModalPrompt) editModalPrompt.value = '';
                    if (editModalNewImage) {
                        editModalNewImage.src = '';
                        editModalNewImage.classList.add('hidden');
                    }
                    if(editModalPlaceholder) editModalPlaceholder.classList.remove('hidden');
                    if(editModalReplaceBtn) editModalReplaceBtn.classList.add('hidden');
                    if(editModalDownloadBtn) editModalDownloadBtn.classList.add('hidden');
                    if(editModalLoader) editModalLoader.classList.add('hidden');
                    
                    // --- BARU: Atur Aspek Rasio Pratinjau Modal ---
                    if (editModalPreview) {
                        // 1. Ambil kelas dari img asli (img ada di scope createMixerCard)
                        const originalClassName = img.className; 
                        
                        // 2. Tentukan kelas rasio yang baru
                        let aspectClass = 'aspect-square'; // Default
                        if (originalClassName.includes('aspect-[9/16]')) aspectClass = 'aspect-[9/16]';
                        else if (originalClassName.includes('aspect-video')) aspectClass = 'aspect-video';
                        else if (originalClassName.includes('aspect-[4/3]')) aspectClass = 'aspect-[4/3]';
                        
                        // 3. Hapus kelas lama dari pratinjau modal
                        editModalPreview.className = editModalPreview.className.replace(/aspect-\[.*?\]|aspect-video|aspect-square/g, '');
                        
                        // 4. Tambahkan kelas baru ke pratinjau modal
                        editModalPreview.classList.add(aspectClass);
                    }
                    // --- AKHIR BARU ---
                    
                    if(editModal) editModal.classList.remove('hidden');

                    // --- BARU: Pre-select aspect ratio dropdown ---
                    // DIHAPUS: Logika untuk mengatur dropdown rasio dihapus
                    /*
                    const editModalAspectRatio = document.getElementById('edit-modal-aspect-ratio');
                    if (editModalAspectRatio) {
...
                    }
                    */
                    // --- AKHIR BARU ---

                    if(typeof lucide !== 'undefined') lucide.createIcons(); // Inisialisasi ikon modal
                });
                // --- AKHIR TOMBOL EDIT BARU ---

                card.appendChild(img); 
                card.appendChild(downloadLink);
                card.appendChild(deleteButton); 
                card.appendChild(editButton); // <- Tambahkan tombol edit ke kartu
                container.appendChild(card); // Tambahkan kartu ke kontainer
            }
            const checkMixerReady = () => {
                if(mixerBtn) mixerBtn.disabled = !(modelFile4 && productFile4 && prompt4 && prompt4.value.trim() !== '');
            };
            if(document.getElementById('drop-zone-4a') && document.getElementById('file-input-4a') && document.getElementById('preview-4a')) {
                setupDropZone(document.getElementById('drop-zone-4a'), document.getElementById('file-input-4a'), document.getElementById('preview-4a'), (file) => { modelFile4 = file; checkMixerReady(); });
            }
            if(document.getElementById('drop-zone-4b') && document.getElementById('file-input-4b') && document.getElementById('preview-4b')) {
                setupDropZone(document.getElementById('drop-zone-4b'), document.getElementById('file-input-4b'), document.getElementById('preview-4b'), (file) => { productFile4 = file; checkMixerReady(); });
            }
            if(prompt4) prompt4.addEventListener('input', checkMixerReady);

            if (mixerBtn) {
                mixerBtn.addEventListener('click', async () => {
                    if (!modelFile4 || !productFile4 || !prompt4 || prompt4.value.trim() === '' || !output4 || !customBg4 || !background4Select) return;
                    showLoader('loader-4', 'mixer-btn');
                    output4.classList.add('hidden'); output4.innerHTML = '';
                    const aspectRatioInput = document.getElementById('aspect-ratio-4');
                    const aspectRatio = aspectRatioInput ? aspectRatioInput.value : '9:16';
                    let background = background4Select.value;
                    const customBg = customBg4.value.trim(); // <-- Get custom BG
                    const userPrompt = prompt4.value.trim();
                    const allBackgrounds = Array.from(background4Select.querySelectorAll('option:not([value="acak"])')).map(opt => opt.value);
                    try {
                        const modelBase64 = await fileToBase64(modelFile4);
                        const productBase64 = await fileToBase64(productFile4);
                        
                        // Definisikan peta rasio di sini untuk placeholder
                        const ratioMap = {
                            '9:16': 'aspect-[9/16]', '16:9': 'aspect-video', '4:3': 'aspect-[4/3]',
                            '1:1': 'aspect-square', '3:4': 'aspect-[3/4]', '4:5': 'aspect-[4/5]'
                        };
                        const aspectClass = ratioMap[aspectRatio] || 'aspect-square';

                        const promises = Array(4).fill(0).map(async (_, index) => {
                            let finalBackground; // <-- Declare
                            if (customBg) {
                                finalBackground = customBg; // <-- Prioritize custom
                            } else if (background === 'acak') {
                                finalBackground = allBackgrounds[Math.floor(Math.random() * allBackgrounds.length)];
                            } else {
                                finalBackground = background; // <-- Fallback to dropdown
                            }
                            const prompt = `Berdasarkan gambar model pertama dan gambar produk kedua, lakukan perintah berikut: "${userPrompt}".
                            Latar belakang harus "${finalBackground}".
                            Sangat penting: JAGA agar fitur wajah dan etnis model di gambar pertama tetap SAMA persis di hasil akhir.
                            Buat gambar akhir dalam rasio aspek ${aspectRatio}. Hasil harus fotorealistis dan berkualitas tinggi. Variasi ${index + 1}.`;

                            const payload = {
                                contents: [{ parts: [{ text: prompt }, { inlineData: { mimeType: modelFile4.type, data: modelBase64 } }, { inlineData: { mimeType: productFile4.type, data: productBase64 } }] }],
                                generationConfig: { responseModalities: ['IMAGE'] }
                            };
                            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image-preview:generateContent?key=${API_KEY}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                            
                            if (!response.ok) throw new Error(`API Error ${response.status}`);
                            const result = await response.json();
                            const candidate = result?.candidates?.[0];
                            if (candidate?.finishReason !== "OK" && candidate?.finishReason !== "STOP") {
                                throw new Error(`Filter Keamanan (${candidate?.finishReason || 'Unknown'})`);
                            }
                            const base64Data = candidate?.content?.parts?.find(p => p.inlineData)?.inlineData?.data;
                            if (!base64Data) throw new Error("Tidak ada data gambar.");
                            return base64Data; // Sukses
                        });

                        // Menggunakan Promise.allSettled untuk menangani kegagalan
                        const settledResults = await Promise.allSettled(promises);

                        output4.innerHTML = ''; // Selalu bersihkan output
                        let successCount = 0;

                        settledResults.forEach((result, index) => {
                            if (result.status === 'fulfilled') {
                                // Sukses: Buat kartu gambar normal
                                createMixerCard(result.value, 'output-4', `image-mix-${index + 1}.png`, aspectRatio);
                                successCount++;
                            } else {
                                // Gagal: Buat kartu placeholder error
                                const errorCard = document.createElement('div');
                                errorCard.className = `result-card rounded-lg overflow-hidden shadow-lg flex flex-col justify-center items-center text-center p-4 ${aspectClass}`;
                                errorCard.style.backgroundColor = 'var(--bg-tertiary)';
                                errorCard.style.border = '1px solid #dc2626'; // Border merah
                                errorCard.innerHTML = `
                                    <i data-lucide="alert-triangle" class="w-10 h-10 text-red-500 mb-2"></i>
                                    <p class="text-sm font-semibold" style="color: var(--text-primary);">Variasi #${index + 1} Gagal</p>
                                    <p class="text-xs" style="color: var(--text-secondary);">${result.reason?.message || 'Error tidak diketahui'}</p>
                                `;
                                output4.appendChild(errorCard);
                            }
                        });

                        output4.classList.remove('hidden');
                        if (typeof lucide !== 'undefined') lucide.createIcons();
                        
                        if (successCount === 0) {
                            showToast("Semua variasi gagal dibuat. Coba instruksi/gambar berbeda.");
                        }

                    } catch (error) { 
                        console.error("Error:", error); 
                        showToast(error.message || "Gagal menggabungkan gambar."); // Mengganti alert dengan toast
                    } finally { 
                        hideLoader('loader-4', 'mixer-btn'); 
                    }
                });
            }
            
            // --- Tool 8: Model Styler ---
            const generateStylerBtn = document.getElementById('generate-styler-btn');
            const output8 = document.getElementById('output-8');
            const customBg8 = document.getElementById('custom-bg-8');
            const background8Select = document.getElementById('background-8');
            let file8 = null;
            function createStylerCard(base64Data, containerId, filename, aspectRatio) {
                 createImageResultCard(base64Data, containerId, filename, aspectRatio);
            }
            if(document.getElementById('drop-zone-8') && document.getElementById('file-input-8') && document.getElementById('preview-8')) {
                setupDropZone(document.getElementById('drop-zone-8'), document.getElementById('file-input-8'), document.getElementById('preview-8'), (selectedFile) => {
                    file8 = selectedFile; if(generateStylerBtn) generateStylerBtn.disabled = false;
                });
            }
            if(generateStylerBtn) {
                generateStylerBtn.addEventListener('click', async () => {
                    if (!file8 || !output8 || !customBg8 || !background8Select) return;
                    showLoader('loader-8', 'generate-styler-btn');
                    output8.classList.add('hidden'); output8.innerHTML = '';
                    const aspectRatioInput = document.getElementById('aspect-ratio-8');
                    const aspectRatio = aspectRatioInput ? aspectRatioInput.value : '9:16';
                    let background = background8Select.value;
                    const customBg = customBg8.value.trim(); // <-- Get custom BG
                    const allBackgrounds = Array.from(background8Select.querySelectorAll('option:not([value="acak"]):not([value="transparan"])')).map(opt => opt.value);
                    const angles = [ "a full body shot, looking at the camera", "a close-up portrait with a soft smile", "a three-quarter shot from the side", "looking over the shoulder", "a dynamic action pose", "laughing candidly", "a professional headshot with a neutral expression", "a profile view, looking away from the camera"];
                    try {
                        const base64Image = await fileToBase64(file8);
                        const promises = angles.map(async (angle) => {
                            let finalBackground; // <-- Declare
                            if (customBg) {
                                finalBackground = customBg; // <-- Prioritize custom
                            } else if (background === 'acak') {
                                finalBackground = allBackgrounds[Math.floor(Math.random() * allBackgrounds.length)];
                            } else {
                                finalBackground = background; // <-- Fallback to dropdown
                            }

                            let prompt;
                            if (finalBackground.toLowerCase() === 'transparan') {
                                 prompt = `This is a model preservation and background-removal task. Take the person from the uploaded image. **IT IS CRITICAL that you perfectly preserve the person's exact face, facial structure, skin tone, ethnicity, AND their entire outfit/clothing.** Do not change their face OR their clothes in any way. Now, render this identical person (with the same face and clothes) in a new pose: '${angle}'. The background MUST be transparent. The final image must be in a ${aspectRatio} aspect ratio.`;
                            } else {
                                 prompt = `This is a model preservation task. Take the person from the uploaded image and place them in a new setting. **IT IS CRITICAL that you perfectly preserve the person's exact face, facial structure, skin tone, ethnicity, AND their entire outfit/clothing.** Do not change their face OR their clothes in any way. Now, render this identical person (with the same face and clothes) in a new pose: '${angle}'. The new background should be '${finalBackground}'. The final image must be in a ${aspectRatio} aspect ratio.`;
                            }
                            const payload = { contents: [{ parts: [{ text: prompt }, { inlineData: { mimeType: file8.type, data: base64Image } }] }], generationConfig: { responseModalities: ['IMAGE'] } };
                            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image-preview:generateContent?key=${API_KEY}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                            if (!response.ok) return null;
                            const result = await response.json();
                            const candidate = result?.candidates?.[0];
                            if (candidate?.finishReason !== "OK" && candidate?.finishReason !== "STOP") { return null; }
                            return candidate?.content?.parts?.find(p => p.inlineData)?.inlineData?.data;
                        });
                        const results = (await Promise.all(promises)).filter(data => data);
                        if (results.length > 0) {
                            results.forEach((base64Data, index) => { createStylerCard(base64Data, 'output-8', `model-style-${index + 1}.png`, aspectRatio); });
                            output8.classList.remove('hidden');
                        } else { throw new Error("Tidak ada gambar yang berhasil dibuat. Ini mungkin karena filter keamanan atau AI kesulitan mendeteksi wajah. Coba dengan foto yang lebih jelas."); }
                    } catch (error) { console.error("Error:", error); alert(error.message || "Gagal mengubah gaya model. Coba lagi.");
                    } finally { hideLoader('loader-8', 'generate-styler-btn'); }
                });
            }

            // --- Tool 9: AI Hashtag Planner ---
            const topicInput9 = document.getElementById('topic-input-9');
            const generateHashtagBtn = document.getElementById('generate-hashtag-btn');
            const output9 = document.getElementById('output-9');
            const copyHashtagsBtn = document.getElementById('copy-hashtags-btn');
            let lastHashtagStrategy = null;

            if (topicInput9 && generateHashtagBtn) {
                topicInput9.addEventListener('input', () => {
                    generateHashtagBtn.disabled = topicInput9.value.trim() === '';
                });

                generateHashtagBtn.addEventListener('click', async () => {
                    const topic = topicInput9.value.trim();
                    if (!topic) return;

                    showLoader('loader-9', 'generate-hashtag-btn');
                    if (output9) output9.classList.add('hidden');

                    try {
                        const prompt = `Act as a TikTok marketing strategist. For the topic "${topic}", create a comprehensive hashtag strategy. Provide a JSON object with the following keys: "primary" (3-5 hashtags directly related to the topic), "broad" (3-5 hashtags for a wider but relevant audience), "trending" (2-3 currently trending but relevant hashtags), "audience" (3-5 hashtags targeting the specific audience for this topic), and "strategy" (a short explanation in Indonesian of why this mix is effective for discoverability). All hashtags should be in Indonesian.`;
                        const schema = {
                            type: "OBJECT",
                            properties: {
                                "primary": { "type": "ARRAY", "items": { "type": "STRING" } },
                                "broad": { "type": "ARRAY", "items": { "type": "STRING" } },
                                "trending": { "type": "ARRAY", "items": { "type": "STRING" } },
                                "audience": { "type": "ARRAY", "items": { "type": "STRING" } },
                                "strategy": { "type": "STRING" }
                            },
                            required: ["primary", "broad", "trending", "audience", "strategy"]
                        };
                        const payload = {
                            contents: [{ parts: [{ text: prompt }] }],
                            generationConfig: { responseMimeType: "application/json", responseSchema: schema }
                        };
                        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${API_KEY}`, {
                            method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload)
                        });
                        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                        const result = await response.json();
                        const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;
                        if (!jsonText) throw new Error("API response did not contain valid JSON text.");
                        const data = JSON.parse(jsonText);
                        lastHashtagStrategy = data;

                        const displayHashtags = (containerId, hashtags) => {
                            const container = document.getElementById(containerId);
                            if (!container) return;
                            container.innerHTML = '';
                            hashtags.forEach(tag => {
                                const span = document.createElement('span');
                                span.className = 'px-2 py-1 rounded'
                                span.style = "background-color: var(--bg-tertiary); color: var(--accent-hover);" // Theme
                                span.innerText = `#${tag.replace(/#/g, '')}`;
                                container.appendChild(span);
                            });
                        };
                        displayHashtags('primary-hashtags-output', data.primary || []);
                        displayHashtags('broad-hashtags-output', data.broad || []);
                        displayHashtags('trending-hashtags-output', data.trending || []);
                        displayHashtags('audience-hashtags-output', data.audience || []);
                        const strategyEl = document.getElementById('strategy-output');
                        if (strategyEl) strategyEl.innerText = data.strategy;
                        if (output9) output9.classList.remove('hidden');
                    } catch (error) {
                        console.error("Error:", error);
                        alert("Gagal membuat strategi hashtag.");
                    } finally {
                        hideLoader('loader-9', 'generate-hashtag-btn');
                    }
                });
            }
            if (copyHashtagsBtn) {
                 copyHashtagsBtn.addEventListener('click', e => {
                    if (lastHashtagStrategy) {
                        const allHashtags = [
                            ...(lastHashtagStrategy.primary || []),
                            ...(lastHashtagStrategy.broad || []),
                            ...(lastHashtagStrategy.trending || []),
                            ...(lastHashtagStrategy.audience || [])
                        ].map(tag => `#${tag.replace(/#/g, '')}`).join(' ');
                        handleCopyClick(e.currentTarget, allHashtags);
                    }
                });
            }


            // --- Tool 5: Script Generator ---
            const productName5 = document.getElementById('product-name-5');
            const productDesc5 = document.getElementById('product-desc-5');
            const scriptInputs = [productName5, productDesc5];
            const generateScriptBtn = document.getElementById('generate-script-btn');
            const regenerateScriptBtn = document.getElementById('regenerate-script-btn');
            const output5 = document.getElementById('output-5');
            const copyScriptBtn = document.getElementById('copy-script-btn');
            const checkScriptReady = () => { if(generateScriptBtn) generateScriptBtn.disabled = scriptInputs.some(input => !input || input.value.trim() === ''); };
            scriptInputs.forEach(input => { if(input) input.addEventListener('input', checkScriptReady) });
            
            const generateScript = async () => {
                if (!productName5 || !productDesc5 || !output5) return;
                showLoader('loader-5', null); 
                if (generateScriptBtn) generateScriptBtn.classList.add('hidden');
                output5.classList.add('hidden');
                try {
                    const styleEl = document.getElementById('style-5');
                    const audienceEl = document.getElementById('audience-5');
                    const style = styleEl ? styleEl.value : 'gaul';
                    const audience = audienceEl ? audienceEl.value : 'umum';
                    const prompt = `Buat naskah promosi TikTok Affiliate untuk produk: "${productName5.value.trim()}". Deskripsi: "${productDesc5.value.trim()}". Buat naskah dengan gaya bahasa ${style} yang menargetkan ${audience}. Gunakan struktur: HOOK, MASALAH, SOLUSI, CTA. Buat juga satu caption singkat yang menarik untuk postingan video. Terakhir, sertakan 7 hashtag yang sangat relevan dengan produk dan deskripsinya. Panjang naskah maksimal 120 kata.`;
                    const schema = { type: "OBJECT", properties: { "hook": { "type": "STRING" }, "masalah": { "type": "STRING" }, "solusi": { "type": "STRING" }, "cta": { "type": "STRING" }, "caption": { "type": "STRING" }, "hashtags": { "type": "ARRAY", "items": { "type": "STRING" } } }, required: ["hook", "masalah", "solusi", "cta", "caption", "hashtags"] };
                    const payload = { contents: [{ parts: [{ text: prompt }] }], generationConfig: { responseMimeType: "application/json", responseSchema: schema } };
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${API_KEY}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    const result = await response.json();
                    const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;
                    if (!jsonText) throw new Error("API response did not contain valid JSON text.");
                    const data = JSON.parse(jsonText);
                    
                    const hookEl = document.getElementById('hook-output');
                    const problemEl = document.getElementById('problem-output');
                    const solutionEl = document.getElementById('solution-output');
                    const ctaEl = document.getElementById('cta-output');
                    const captionEl = document.getElementById('caption-output');
                    const hashtagsContainer = document.getElementById('hashtags-output');

                    if(hookEl) hookEl.innerText = data.hook; 
                    if(problemEl) problemEl.innerText = data.masalah;
                    if(solutionEl) solutionEl.innerText = data.solusi; 
                    if(ctaEl) ctaEl.innerText = data.cta;
                    if(captionEl) captionEl.innerText = data.caption;
                    if (hashtagsContainer) {
                         hashtagsContainer.innerHTML = '';
                        (data.hashtags || []).forEach(tag => { 
                            const span = document.createElement('span'); 
                            span.className = 'px-2 py-1 rounded'; 
                            span.style = "background-color: var(--bg-tertiary); color: var(--accent-hover);" // Theme
                            span.innerText = `#${tag.replace(/#/g, '')}`; 
                            hashtagsContainer.appendChild(span); 
                        });
                    }
                    output5.classList.remove('hidden');
                } catch(error) { console.error("Error:", error); alert("Gagal membuat naskah.");
                } finally { hideLoader('loader-5', null); if (generateScriptBtn) generateScriptBtn.classList.remove('hidden'); }
            };
            if(generateScriptBtn) generateScriptBtn.addEventListener('click', generateScript);
            if(regenerateScriptBtn) regenerateScriptBtn.addEventListener('click', generateScript);
            if(copyScriptBtn) {
                 copyScriptBtn.addEventListener('click', e => {
                    const hook = document.getElementById('hook-output')?.innerText || ''; 
                    const problem = document.getElementById('problem-output')?.innerText || ''; 
                    const solution = document.getElementById('solution-output')?.innerText || ''; 
                    const cta = document.getElementById('cta-output')?.innerText || '';
                    const caption = document.getElementById('caption-output')?.innerText || '';
                    const hashtags = Array.from(document.querySelectorAll('#hashtags-output span')).map(s => s.innerText).join(' ');
                    const fullText = `CAPTION VIDEO:\n${caption}\n\n====================\n\nDETAIL NASKAH:\n\n[HOOK üé£]\n${hook}\n\n[MASALAH üò•]\n${problem}\n\n[SOLUSI ‚ú®]\n${solution}\n\n[CTA üõí]\n${cta}\n\nHASHTAGS:\n${hashtags}`;
                    handleCopyClick(e.currentTarget, fullText);
                });
            }

            // --- Tool 6: Text to Speech ---
            const allVoices = { "Pria": { "Puck (Upbeat)": "Puck", "Charon (Informative)": "Charon", "Kore (Firm)": "Kore", "Fenrir (Excitable)": "Fenrir", "Orus (Firm)": "Orus", "Iapetus (Clear)": "Iapetus", "Algenib (Gravelly)": "Algenib", "Rasalgethi (Informative)": "Rasalgethi", "Laomedeia (Upbeat)": "Laomedeia", "Alnilam (Firm)": "Alnilam", "Achird (Friendly)": "Achird", "Zubenelgenubi (Casual)": "Zubenelgenubi", "Sadaltager (Knowledgeable)": "Sadaltager" }, "Wanita": { "Zephyr (Bright)": "Zephyr", "Leda (Youthful)": "Leda", "Aoede (Breezy)": "Aoede", "Callirrhoe (Easy-going)": "Callirrhoe", "Autonoe (Bright)": "Autonoe", "Enceladus (Breathy)": "Enceladus", "Umbriel (Easy-going)": "Umbriel", "Algieba (Smooth)": "Algieba", "Despina (Smooth)": "Despina", "Erinome (Clear)": "Erinome", "Achernar (Soft)": "Achernar", "Schedar (Even)": "Schedar", "Gacrux (Mature)": "Gacrux", "Pulcherrima (Forward)": "Pulcherrima", "Vindemiatrix (Gentle)": "Vindemiatrix", "Sadachbia (Lively)": "Sadachbia", "Sulafat (Warm)": "Sulafat" } };
            const voiceSelect = document.getElementById('voice-select-6');
            if (voiceSelect) {
                for (const gender in allVoices) {
                    const optgroup = document.createElement('optgroup');
                    optgroup.label = `Suara ${gender}`;
                    for (const name in allVoices[gender]) {
                        const option = document.createElement('option');
                        option.value = allVoices[gender][name];
                        option.textContent = name;
                        optgroup.appendChild(option);
                    }
                    voiceSelect.appendChild(optgroup);
                }
            }
            const ttsInput = document.getElementById('tts-input-6');
            const generateAudioBtn = document.getElementById('generate-audio-btn');
            const output6 = document.getElementById('output-6');
            if(ttsInput && generateAudioBtn) ttsInput.addEventListener('input', () => { generateAudioBtn.disabled = ttsInput.value.trim() === ''; });
            const base64ToArrayBuffer = b64 => {const s=window.atob(b64),l=s.length,B=new Uint8Array(l);for(let i=0;i<l;i++)B[i]=s.charCodeAt(i);return B.buffer;};
            const pcmToWav = (pcm, rate) => {const dS=pcm.length*2,b=new ArrayBuffer(44+dS),v=new DataView(b);function w(v,o,s){for(let i=0;i<s.length;i++)v.setUint8(o+i,s.charCodeAt(i));}w(v,0,'RIFF');v.setUint32(4,36+dS,true);w(v,8,'WAVE');w(v,12,'fmt ');v.setUint32(16,16,true);v.setUint16(20,1,true);v.setUint16(22,1,true);v.setUint32(24,rate,true);v.setUint32(28,rate*2,true);v.setUint16(32,2,true);v.setUint16(34,16,true);w(v,36,'data');v.setUint32(40,dS,true);new Int16Array(b,44).set(pcm);return new Blob([v],{type:'audio/wav'});};
            
            if (generateAudioBtn) {
                 generateAudioBtn.addEventListener('click', async () => {
                    const text = ttsInput ? ttsInput.value.trim() : ''; if (!text) return;
                    showLoader('loader-6', 'generate-audio-btn'); 
                    if(output6) output6.classList.add('hidden');
                    try {
                        const voice = voiceSelect ? voiceSelect.value : 'Puck'; 
                        const styleEl = document.getElementById('style-select-6');
                        const style = styleEl ? styleEl.value : 'ceria';
                        const payload = { contents: [{ parts: [{ text: `Ucapkan dengan gaya ${style}: ${text}` }] }], generationConfig: { responseModalities: ["AUDIO"], speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: voice } } } }, model: "gemini-2.5-flash-preview-tts" };
                        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${API_KEY}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                        const result = await response.json(), part = result?.candidates?.[0]?.content?.parts?.[0], audioData = part?.inlineData?.data, mimeType = part?.inlineData?.mimeType;
                        if (audioData && mimeType?.startsWith("audio/")) {
                            const rateMatch = mimeType.match(/rate=(\d+)/);
                            if (!rateMatch) throw new Error("Could not parse sample rate from mimeType.");
                            const rate = parseInt(rateMatch[1], 10);
                            const pcm16 = new Int16Array(base64ToArrayBuffer(audioData)), wav = pcmToWav(pcm16, rate), url = URL.createObjectURL(wav);
                            const audioSource = document.getElementById('audio-source');
                            const downloadBtn = document.getElementById('download-audio-btn');
                            const audioEl = document.querySelector('#output-6 audio');
                            if(audioSource) audioSource.src = url; 
                            if(downloadBtn) downloadBtn.href = url;
                            if(audioEl) audioEl.load(); 
                            if(output6) output6.classList.remove('hidden');
                        } else throw new Error("No audio data in response.");
                    } catch (error) { console.error("Error:", error); alert("Gagal membuat audio.");
                    } finally { hideLoader('loader-6', 'generate-audio-btn'); }
                });
            }

            // --- Tool 7: Video Analysis ---
            const imageUpload7 = document.getElementById('image-upload-7');
            const imagePreviewContainer7 = document.getElementById('image-preview-container-7');
            const imagePreview7 = document.getElementById('image-preview-7');
            const imagePlaceholder7 = document.getElementById('image-placeholder-7');
            const analyzeButton7 = document.getElementById('analyze-button-7');
            const clearButton7 = document.getElementById('clear-button-7');
            
            // --- Elemen BARU untuk Tool 7 ---
            const loader7 = document.getElementById('loader-7');
            const resultsContainer7 = document.getElementById('results-container-7');
            // DIUBAH: Menargetkan <textarea> baru, bukan <code>
            const textOutput7 = document.getElementById('text-output-7');
            // DIUBAH: Menargetkan tombol baru
            const copyPromptBtn7 = document.getElementById('copy-prompt-7');
            // Input Kontrol Baru
            const veoPreset7 = document.getElementById('veo-preset-7');
            const veoCamera7 = document.getElementById('veo-camera-7');
            const veoAnim7 = document.getElementById('veo-anim-7');
            const veoAction7 = document.getElementById('veo-action-7');
            const veoDialogue7 = document.getElementById('veo-dialogue-7');
            // --- Akhir Elemen BARU ---

            const dialogInput7 = document.getElementById('dialog-input-7'); // Ini sepertinya elemen lama/salah, tapi kita biarkan jika ada
            const uploadLabel7 = document.querySelector('label[for="image-upload-7"]');
            // DIUBAH: Variabel untuk menyimpan hasil
            let imageData7 = null, lastPrompt7 = null;
            
            const resetVideoAnalysis = () => {
                // DIUBAH: Variabel reset
                imageData7 = null; lastPrompt7 = null;
                if(imageUpload7) imageUpload7.value = '';
                if(imagePreview7) { imagePreview7.src = ''; imagePreview7.classList.add('hidden'); }
                if(imagePlaceholder7) imagePlaceholder7.classList.remove('hidden');
                if(imagePreviewContainer7) imagePreviewContainer7.classList.add('hidden');
                if(uploadLabel7) uploadLabel7.classList.remove('hidden');
                if(analyzeButton7) analyzeButton7.disabled = true;
                if(clearButton7) clearButton7.classList.add('hidden');
                
                // --- BARU: Reset hasil dan kontrol baru ---
                if(resultsContainer7) resultsContainer7.classList.add('hidden');
                // DIUBAH: Reset <textarea>
                if(textOutput7) textOutput7.value = '';
                if(veoPreset7) veoPreset7.value = 'cinematic';
                if(veoCamera7) veoCamera7.value = 'biarkan AI yang menentukan';
                if(veoAnim7) veoAnim7.value = 'subtle natural animation (e.g., wind, hair moving, water ripples)';
                if(veoAction7) veoAction7.value = '';
                if(veoDialogue7) veoDialogue7.value = '';
                // --- Akhir BARU ---

                if(dialogInput7) dialogInput7.value = '';
            };

            if(clearButton7) clearButton7.addEventListener('click', resetVideoAnalysis);

            if (imageUpload7) {
                imageUpload7.addEventListener('change', (event) => {
                    const file = event.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            imageData7 = { mimeType: file.type, data: e.target.result.split(',')[1] };
                            if(imagePreview7) { imagePreview7.src = e.target.result; imagePreview7.classList.remove('hidden'); }
                            if(imagePlaceholder7) imagePlaceholder7.classList.add('hidden');
                            if(imagePreviewContainer7) imagePreviewContainer7.classList.remove('hidden');
                            if(uploadLabel7) uploadLabel7.classList.add('hidden');
                            // --- PINDAHKAN LOGIKA INI KE SINI ---
                            if(analyzeButton7) analyzeButton7.disabled = false; // <-- DIPERBAIKI: Pindahkan ke sini
                            if(clearButton7) clearButton7.classList.remove('hidden');
                            // --- AKHIR PERBAIKAN ---
                        };
                        reader.readAsDataURL(file);
                        // DIHAPUS: Baris-baris ini dieksekusi terlalu cepat
                        // if(analyzeButton7) analyzeButton7.disabled = false; 
                        // if(clearButton7) clearButton7.classList.remove('hidden'); 
                    }
                });
            }
            if (analyzeButton7) {
                 // --- LOGIKA LAMA DIHAPUS DAN DIGANTI ---
                 analyzeButton7.addEventListener('click', async () => {
                    // DIUBAH: Memeriksa elemen output baru
                    if (!imageData7 || !loader7 || !resultsContainer7 || !textOutput7) return;
                    
                    showLoader('loader-7', 'analyze-button-7'); // Menggunakan showLoader
                    resultsContainer7.classList.add('hidden');
                    // DIUBAH: Mengosongkan <textarea>
                    textOutput7.value = '';

                    try {
                        // 1. Kumpulkan semua input baru
                        const preset = veoPreset7 ? veoPreset7.value : 'cinematic';
                        const camera = veoCamera7 ? veoCamera7.value : 'biarkan AI yang menentukan';
                        const animation = veoAnim7 ? veoAnim7.value : 'subtle natural animation';
                        const action = veoAction7 ? veoAction7.value.trim() : '';
                        const dialogue = veoDialogue7 ? veoDialogue7.value.trim() : '';

                        // 2. Buat Prompt Teks Sederhana (BUKAN JSON)
                        let prompt = `Act as an expert Veo 3 prompt engineer. Analyze the uploaded image and the user's requirements to create a single, combined, ready-to-use prompt for Veo 3.
The prompt MUST be in ENGLISH.

USER REQUIREMENTS:
- Style Preset: ${preset}
- Camera Movement: ${camera}
- Natural Animation: ${animation}
- Specific Action: ${action || 'None specified'}
- Dialogue: ${dialogue || 'None specified'}

YOUR TASK:
Create a single, continuous block of text.
1.  Start with a detailed, photorealistic description of the scene, main subject, objects, and lighting from the image.
2.  Naturally weave all the user's requirements (style: "${preset}", camera: "${camera}", animation: "${animation}", action: "${action}") into this description.
3.  If dialogue is provided ("${dialogue}"), add it at the end in quotes, like: (dialogue: "${dialogue}").
4.  Finally, on a new line, add a powerful, combined negative prompt. Start this line with "--neg".

Example Output Format:
A ${preset}, ${camera} shot of a [subject] in a [scene]... [action].
--neg blurry, grainy, low-resolution, unrealistic, cartoon, 3d render, cgi, watermark, text, deformed, ugly, bad anatomy, mutated hands, artifacts, compression, noise, oversaturated, distorted
`;

                        // 3. HAPUS SKEMA JSON
                        
                        // 4. Buat Payload (Tanpa generationConfig JSON)
                        const payload = {
                            contents: [
                                { parts: [{ text: prompt }, { inlineData: imageData7 }] }
                            ]
                            // generationConfig dan systemInstruction dihapus untuk mendapatkan teks biasa
                        };

                        // 5. Panggil API
                        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${API_KEY}`, { 
                            method: 'POST', 
                            headers: { 'Content-Type': 'application/json' }, 
                            body: JSON.stringify(payload) 
                        });

                        if (!response.ok) {
                            const errorText = await response.text();
                            throw new Error(`API request failed with status ${response.status}: ${errorText}`);
                        }
                        
                        const result = await response.json();
                        // DIUBAH: Langsung ambil teks, bukan JSON
                        const plainText = result.candidates?.[0]?.content?.parts?.[0]?.text;
                        
                        if (plainText) {
                            // Hapus logika parsing JSON
                            lastPrompt7 = plainText.trim(); // Simpan untuk disalin
                            textOutput7.value = lastPrompt7; // Tampilkan di textarea
                            resultsContainer7.classList.remove('hidden');
                        } else { 
                            throw new Error("Respons API tidak valid atau kosong."); 
                        }
                    } catch (error) {
                        console.error("Error:", error);
                        // DIUBAH: Tampilkan error di textarea
                        textOutput7.value = `Terjadi kesalahan: ${error.message}`;
                        resultsContainer7.classList.remove('hidden'); // Tampilkan error di kontainer
                    } finally {
                        hideLoader('loader-7', 'analyze-button-7'); // Menggunakan hideLoader
                    }
                });
            }
            
            // --- BARU: Event listener untuk tombol salin JSON ---
            // DIUBAH: Menargetkan tombol baru dan menyalin dari lastPrompt7
            if(copyPromptBtn7) {
                copyPromptBtn7.addEventListener('click', (e) => {
                    if(lastPrompt7) {
                        handleCopyClick(e.currentTarget, lastPrompt7);
                        showToast("Prompt disalin!"); // Pesan kustom
                    }
                });
            }
            // --- Akhir BARU ---


            // --- Tool 11: UGC Content Generator (BARU) ---
            const dropZone11 = document.getElementById('drop-zone-11');
            const fileInput11 = document.getElementById('file-input-11');
            const preview11 = document.getElementById('preview-11');
            const categorySelect11 = document.getElementById('category-select-11');
            
            const styleSection11 = document.getElementById('style-section-11');
            const styleSelect11 = document.getElementById('style-select-11');
            
            const toneSection11 = document.getElementById('tone-section-11'); // <-- BARU
            const toneSelect11 = document.getElementById('tone-select-11'); // <-- BARU
            
            const modelSection11 = document.getElementById('model-section-11');
            const dropZone12 = document.getElementById('drop-zone-12');
            const fileInput12 = document.getElementById('file-input-12');
            const preview12 = document.getElementById('preview-12');
            
            const ratioSection11 = document.getElementById('ratio-section-11');
            const aspectRatio11 = document.getElementById('aspect-ratio-11');
            
            const generateUgcBtn = document.getElementById('generate-ugc-btn');
            const loader11 = document.getElementById('loader-11');
            const output11 = document.getElementById('output-11');

            let file11 = null; // Product file
            let file12 = null; // Model file

            const styleOptions11 = {
                "fashion-top": [
                    { value: "full body look, model standing in a chic urban street", text: "Full body look (di jalanan kota)" },
                    { value: "half body shot, model against minimalist studio background", text: "Setengah badan (studio minimalis)" },
                    { value: "waist down shot of model, walking pose, blurred background", text: "Dari perut ke bawah (pose jalan)" }
                ],
                "fashion-shoes": [
                    { value: "full body shot of a model wearing the shoes, walking on pavement", text: "Full body (model memakai sepatu)" },
                    { value: "close-up of the shoe on a minimalist podium or stylized table", text: "Review style (di atas meja/podium)" },
                    { value: "point of view (POV) shot, looking down at the shoes while walking on a cool surface", text: "POV (seolah sedang dipakai)" }
                ],
                "product-packaged": [
                    { value: "a lifestyle shot of a model holding the product and smiling, bright environment", text: "Model memegang produk (lifestyle)" },
                    { value: "product displayed on a thematic table (e.g., marble for skincare, wood for food)", text: "Produk di atas meja (tematik)" },
                    { value: "clean editorial studio shot, minimalist background, professional lighting", text: "Gaya editorial (clean studio)" }
                ],
                "product-furniture": [
                    { value: "product (e.g., chair, table) placed in a well-lit, matching interior room (e.g., living room, kitchen)", text: "Produk di dalam ruangan (kontekstual)" },
                    { value: "lifestyle shot with a person interacting with the furniture (e.g., sitting on the chair)", text: "Model berinteraksi dengan produk" }
                ],
                "product-other": [
                    { value: "lifestyle shot of a model using the product naturally", text: "Model menggunakan produk" },
                    { value: "product on a clean studio background, bright lighting", text: "Clean studio" }
                ]
            };

            const checkUgcReady = () => {
                if (generateUgcBtn) {
                    const isReady = file11 && categorySelect11 && categorySelect11.value !== "" && styleSelect11 && styleSelect11.value !== "";
                    generateUgcBtn.disabled = !isReady;
                }
            };

            if (dropZone11 && fileInput11 && preview11) {
                setupDropZone(dropZone11, fileInput11, preview11, (selectedFile) => {
                    file11 = selectedFile;
                    if (categorySelect11) categorySelect11.disabled = false;
                    checkUgcReady();
                    // Reset subsequent steps
                    if (styleSection11) styleSection11.classList.add('hidden');
                    if (toneSection11) toneSection11.classList.add('hidden'); // <-- BARU
                    if (modelSection11) modelSection11.classList.add('hidden');
                    if (ratioSection11) ratioSection11.classList.add('hidden');
                    if (styleSelect11) styleSelect11.innerHTML = '<option value="">Pilih gaya konten...</option>';
                    if (preview12) preview12.classList.add('hidden');
                    if (fileInput12) fileInput12.value = '';
                    file12 = null;
                });
            }
            
            if (dropZone12 && fileInput12 && preview12) {
                setupDropZone(dropZone12, fileInput12, preview12, (selectedFile) => {
                    // Validasi ukuran file
                    if (selectedFile.size > 5 * 1024 * 1024) { // 5MB
                        showToast("Error: File referensi terlalu besar (Maks 5MB).");
                        file12 = null;
                        if (fileInput12) fileInput12.value = ''; // Clear input
                        if (preview12) preview12.classList.add('hidden'); // Hide preview
                        return;
                    }
                    file12 = selectedFile;
                    // file12 is optional, so no need to call checkUgcReady() here to enable button
                });
            }

            if (categorySelect11) {
                categorySelect11.addEventListener('change', () => {
                    const category = categorySelect11.value;
                    if (styleSelect11 && styleSection11 && modelSection11 && ratioSection11 && toneSection11) { // <-- BARU (tambah toneSection11)
                        styleSelect11.innerHTML = '<option value="">Pilih gaya konten...</option>'; // Reset
                        const options = styleOptions11[category] || styleOptions11['product-other'];
                        
                        options.forEach(opt => {
                            const optionEl = document.createElement('option');
                            optionEl.value = opt.value;
                            optionEl.textContent = opt.text;
                            styleSelect11.appendChild(optionEl);
                        });

                        styleSection11.classList.remove('hidden');
                        toneSection11.classList.remove('hidden'); // <-- BARU
                        modelSection11.classList.remove('hidden');
                        ratioSection11.classList.remove('hidden');
                    }
                    checkUgcReady();
                });
            }
            
            if (styleSelect11) {
                styleSelect11.addEventListener('input', checkUgcReady);
            }

            // --- BARU: Mengganti listener 'input' di atas dengan 'change' untuk menangani show/hide
            if (styleSelect11) {
                // MENGGANTIKAN: styleSelect11.addEventListener('input', checkUgcReady);
                styleSelect11.addEventListener('change', () => {
                    checkUgcReady(); // Tetap panggil checkReady
                    
                    const modelOptionsContainer = document.getElementById('model-options-11');
                    if (modelOptionsContainer) {
                        const style = styleSelect11.value;
                        // Logika ini sama dengan yang ada di tombol generate, untuk konsistensi
                        const styleIncludesModel = /model|person|lifestyle|wearing|shot of a model|using the product|pose jalan/i.test(style);
                        // Tampilkan/sembunyikan dropdown gender/etnis
                        modelOptionsContainer.classList.toggle('hidden', !styleIncludesModel);
                    }
                });
            }
            // --- AKHIR PERUBAHAN ---

            if (generateUgcBtn) {
                generateUgcBtn.addEventListener('click', async () => {
                    if (!file11 || !categorySelect11.value || !styleSelect11.value || !aspectRatio11) return;

                    showLoader('loader-11', 'generate-ugc-btn');
                    if (output11) {
                        output11.classList.add('hidden');
                        output11.innerHTML = '';
                    }

                    try {
                        // 1. Get all data
                        const productBase64 = await fileToBase64(file11);
                        let modelBase64 = null;
                        if (file12) {
                            modelBase64 = await fileToBase64(file12);
                        }
                        const style = styleSelect11.value;
                        const aspectRatio = aspectRatio11.value;
                        const tone = toneSelect11 ? toneSelect11.value : 'natural, realistic colors'; // <-- BARU

                        // Tentukan jumlah gambar yang diinginkan
                        const NUM_IMAGES = 8;

                        // Salin ratioMap untuk placeholder
                        const ratioMap = {
                            '9:16': 'aspect-[9/16]', '16:9': 'aspect-video', '4:3': 'aspect-[4/3]',
                            '1:1': 'aspect-square', '3:4': 'aspect-[3/4]', '4:5': 'aspect-[4/5]'
                        };
                        const aspectClass = ratioMap[aspectRatio] || 'aspect-square';

                        // Tampilkan placeholder yang berkedip
                        if (output11) {
                            output11.innerHTML = ''; // Bersihkan hasil lama
                            for (let i = 0; i < NUM_IMAGES; i++) {
                                output11.innerHTML += `<div class="pulse-placeholder ${aspectClass}"></div>`;
                            }
                            output11.classList.remove('hidden');
                        }

                        // 2. Buat array promise
                        const promises = Array(NUM_IMAGES).fill(0).map(async (_, index) => {
                            // 2. Construct prompt
                            let prompt = `Generate one high-quality, photorealistic UGC-style image.
                            - **Product:** The image must feature the product from the first uploaded image.
                            - **Style:** The scene and model pose must match this style: "${style}".
                            - **Color Tone:** The image must have a specific color grading and aesthetic: "${tone}".
                            - **Aspect Ratio:** The final image must have an aspect ratio of ${aspectRatio}.
                            - **Variation:** This is variation ${index + 1} of ${NUM_IMAGES} to ensure uniqueness.`;
                            
                            const contentParts = [
                                { text: "" }, // Placeholder for prompt
                                { inlineData: { mimeType: file11.type, data: productBase64 } }
                            ];

                            if (modelBase64) {
                                prompt += `\n- **Model Reference:** The model in the generated image must have the same facial features, ethnicity, and hair style as the person in the second uploaded image (the reference model). This is a critical instruction.`;
                                contentParts.push({ inlineData: { mimeType: file12.type, data: modelBase64 } });
                            } else {
                                // DIUBAH: Logika yang diperbarui untuk menangani gaya "produk saja"
                                // Memeriksa apakah string gaya menyiratkan adanya model
                                const styleIncludesModel = /model|person|lifestyle|wearing|shot of a model|using the product|pose jalan/i.test(style);
    
                                if (styleIncludesModel) {
                                    // --- LOGIKA BARU DIMASUKKAN DI SINI ---
                                    const genderSelect = document.getElementById('model-gender-11');
                                    const etnisSelect = document.getElementById('model-etnis-11');
                                    const selectedGenderVal = genderSelect ? genderSelect.value : 'bebas';
                                    const selectedEtnisVal = etnisSelect ? etnisSelect.value : 'bebas';

                                    // Pemetaan (Indonesia) ke (English untuk prompt AI)
                                    const genderMap = { 'pria': 'male', 'wanita': 'female' };
                                    const etnisMap = {
                                        'indonesia': 'Indonesian',
                                        'korea': 'Korean',
                                        'jepang': 'Japanese',
                                        'tiongkok': 'Chinese',
                                        'amerika-kaukasia': 'White American (Caucasian)',
                                        'amerika-afrika': 'Black American (African-American)',
                                        'eropa': 'European (e.g., French, German)',
                                        'timur-tengah': 'Middle Eastern (e.g., Arab)',
                                        'india': 'Indian',
                                        'latin': 'Latino/Latina (e.g., Brazilian, Mexican)'
                                    };

                                    let modelDesc = "Include a suitable model for this product and style.";
                                    
                                    if (genderMap[selectedGenderVal]) {
                                        modelDesc += ` The model must be ${genderMap[selectedGenderVal]}.`;
                                    }
                                    
                                    if (etnisMap[selectedEtnisVal]) {
                                        modelDesc += ` The model's ethnicity must be ${etnisMap[selectedEtnisVal]}.`;
                                    }
                                    
                                    prompt += `\n- **Model:** ${modelDesc}`;
                                    // --- AKHIR LOGIKA BARU ---

                                } else {
                                    // Jika tidak ada referensi model DAN gayanya tidak menyiratkan model (misalnya "kontekstual" atau "clean studio"),
                                    // secara eksplisit perintahkan AI untuk FOKUS HANYA PADA PRODUK.
                                    prompt += `\n- **Fokus:** Do NOT include any person or model. The image must focus only on the product within its context.`;
                                }
                            }
                            
                            contentParts[0].text = prompt; // Set the final prompt

                            // 3. API Call
                            const payload = {
                                contents: [{ parts: contentParts }],
                                generationConfig: { responseModalities: ['IMAGE'] }
                            };
                            
                            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image-preview:generateContent?key=${API_KEY}`, {
                                method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload)
                            });

                            if (!response.ok) {
                                const errorBody = await response.json();
                                throw new Error(`API Error ${response.status}: ${errorBody.error?.message || 'Unknown error'}`);
                            }
                            
                            const result = await response.json();
                            const candidate = result?.candidates?.[0];
                            if (candidate?.finishReason !== "OK" && candidate?.finishReason !== "STOP") {
                                throw new Error(`Filter Keamanan: ${candidate?.finishReason || 'Unknown'}`);
                            }
                            const base64Data = candidate?.content?.parts?.find(p => p.inlineData)?.inlineData?.data;

                            if (!base64Data) {
                                throw new Error("Tidak ada data gambar yang diterima dari API.");
                            }
                            return base64Data; // Sukses
                        });

                        // 4. Tunggu semua promise selesai
                        const settledResults = await Promise.allSettled(promises);

                        // 5. Tampilkan hasil
                        if (output11) output11.innerHTML = ''; // Bersihkan placeholder
                        let successCount = 0;

                        settledResults.forEach((result, index) => {
                            if (result.status === 'fulfilled' && output11) {
                                // Sukses: Buat kartu gambar
                                createImageResultCard(result.value, 'output-11', `ugc-result-${index + 1}.png`, aspectRatio);
                                successCount++;
                            } else if (output11) {
                                // Gagal: Tampilkan kartu error
                                console.error(`Gagal membuat variasi #${index + 1}:`, result.reason);
                                const errorCard = document.createElement('div');
                                errorCard.className = `result-card rounded-lg overflow-hidden shadow-lg flex flex-col justify-center items-center text-center p-4 ${aspectClass}`;
                                errorCard.style.backgroundColor = 'var(--bg-tertiary)';
                                errorCard.style.border = '1px solid #dc2626'; // border merah
                                errorCard.innerHTML = `
                                    <i data-lucide="alert-triangle" class="w-10 h-10 text-red-500 mb-2"></i>
                                    <p class="text-sm font-semibold" style="color: var(--text-primary);">Variasi #${index + 1} Gagal</p>
                                    <p class="text-xs" style="color: var(--text-secondary);">${result.reason?.message || 'Error'}</p>
                                `;
                                output11.appendChild(errorCard);
                            }
                        });

                        if (output11) {
                            output11.classList.remove('hidden');
                            if (typeof lucide !== 'undefined') lucide.createIcons(); // Render ikon (untuk kartu error)
                        }

                        if (successCount === 0) {
                            throw new Error("Semua variasi gambar gagal dibuat. Coba lagi.");
                        }

                    } catch (error) {
                        console.error("Error generating UGC content:", error);
                        showToast(error.message || "Gagal membuat konten UGC."); // Gunakan toast untuk error
                    } finally {
                        hideLoader('loader-11', 'generate-ugc-btn');
                    }
                });
            }
            // --- AKHIR Tool 11 ---


            // --- LOGIKA MODAL EDIT (BARU) ---
            const editModal = document.getElementById('editModal');
            const editModalCloseBtn = document.getElementById('edit-modal-close-btn');
            const editModalGenerateBtn = document.getElementById('edit-modal-generate-btn');
            const editModalReplaceBtn = document.getElementById('edit-modal-replace-btn');
            const editModalDownloadBtn = document.getElementById('edit-modal-download-btn');
            const editModalPrompt = document.getElementById('edit-modal-prompt');
            const editModalLoader = document.getElementById('edit-modal-loader');
            const editModalPlaceholder = document.getElementById('edit-modal-placeholder');
            const editModalNewImage = document.getElementById('edit-modal-new-image');
            
            let newEditedBase64 = null; // Menyimpan base64 hasil editan

            if (editModalCloseBtn) {
                editModalCloseBtn.addEventListener('click', () => {
                    if(editModal) editModal.classList.add('hidden');
                    newEditedBase64 = null; // Bersihkan saat ditutup
                });
            }

            if (editModalGenerateBtn) {
                editModalGenerateBtn.addEventListener('click', async () => {
                    const instruction = editModalPrompt ? editModalPrompt.value.trim() : '';
                    if (!instruction) {
                        showToast("Silakan masukkan instruksi edit.");
                        return;
                    }
                    if (!activeEditCard.base64) {
                        showToast("Gambar asli tidak ditemukan.");
                        return;
                    }

                    // Tampilkan loader, sembunyikan yang lain
                    if(editModalLoader) editModalLoader.classList.remove('hidden');
                    if(editModalPlaceholder) editModalPlaceholder.classList.add('hidden');
                    if(editModalNewImage) editModalNewImage.classList.add('hidden');
                    if(editModalReplaceBtn) editModalReplaceBtn.classList.add('hidden');
                    if(editModalDownloadBtn) editModalDownloadBtn.classList.add('hidden');
                    editModalGenerateBtn.disabled = true;

                    try {
                        // --- DIUBAH: Baca rasio aspek dari dropdown baru ---
                        // DIHAPUS: Logika rasio dihapus
                        /*
                        const editModalAspectRatioSelect = document.getElementById('edit-modal-aspect-ratio');
                        const aspectRatio = editModalAspectRatioSelect ? editModalAspectRatioSelect.value : '1:1';
                        */
                        // --- AKHIR PERUBAHAN ---
                        
                        // Dapatkan rasio aspek DARI GAMBAR ASLI untuk konsistensi
                        const originalImg = activeEditCard.cardElement.querySelector('img');
                        const originalClassName = originalImg.className;
                        let aspectRatio = '1:1'; // Default
                        if (originalClassName.includes('aspect-[9/16]')) aspectRatio = '9:16';
                        else if (originalClassName.includes('aspect-video')) aspectRatio = '16:9';
                        else if (originalClassName.includes('aspect-[4/3]')) aspectRatio = '4:3';


                        const combinedPrompt = `Based on the uploaded image, edit it by following this instruction: "${instruction}". Preserve the parts of the image not related to the instruction. The aspect ratio must be ${aspectRatio}.`;
                        
                        const payload = {
                            contents: [{
                                parts: [
                                    { text: combinedPrompt },
                                    { inlineData: { mimeType: 'image/png', data: activeEditCard.base64 } }
                                ]
                            }],
                            generationConfig: { responseModalities: ['IMAGE'] }
                        };

                        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image-preview:generateContent?key=${API_KEY}`, {
                            method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload)
                        });

                        if (!response.ok) throw new Error(`API Error ${response.status}`);
                        const result = await response.json();
                        const candidate = result?.candidates?.[0];
                        if (candidate?.finishReason !== "OK" && candidate?.finishReason !== "STOP") {
                            throw new Error(`Filter Keamanan (${candidate?.finishReason || 'Unknown'})`);
                        }
                        const base64Data = candidate?.content?.parts?.find(p => p.inlineData)?.inlineData?.data;

                        if (base64Data) {
                            newEditedBase64 = base64Data; // Simpan base64 baru
                            const newSrc = `data:image/png;base64,${newEditedBase64}`;
                            if (editModalNewImage) {
                                editModalNewImage.src = newSrc;
                                editModalNewImage.classList.remove('hidden');
                            }
                            if (editModalDownloadBtn) {
                                editModalDownloadBtn.href = newSrc;
                                editModalDownloadBtn.classList.remove('hidden');
                            }
                            if (editModalReplaceBtn) editModalReplaceBtn.classList.remove('hidden');
                        } else {
                            throw new Error("Tidak ada data gambar yang diterima.");
                        }

                    } catch (error) {
                        console.error("Error editing image:", error);
                        showToast(error.message || "Gagal mengedit gambar.");
                        if(editModalPlaceholder) editModalPlaceholder.classList.remove('hidden'); // Tampilkan placeholder lagi
                    } finally {
                        if(editModalLoader) editModalLoader.classList.add('hidden');
                        editModalGenerateBtn.disabled = false;
                    }
                });
            }

            if (editModalReplaceBtn) {
                editModalReplaceBtn.addEventListener('click', () => {
                    if (!newEditedBase64 || !activeEditCard.cardElement) {
                        showToast("Gagal mengganti gambar.");
                        return;
                    }

                    const newSrc = `data:image/png;base64,${newEditedBase64}`;

                    // Temukan elemen di kartu asli
                    const originalImg = activeEditCard.cardElement.querySelector('img');
                    const originalDownload = activeEditCard.cardElement.querySelector('a');

                    if (originalImg) {
                        originalImg.src = newSrc;
                        
                        // --- BARU: Update kelas aspek rasio ---
                        // DIHAPUS: Logika penggantian rasio dihapus, karena tidak akan pernah berubah
                        /*
                        const editModalAspectRatioSelect = document.getElementById('edit-modal-aspect-ratio');
                        const newAspectRatio = editModalAspectRatioSelect ? editModalAspectRatioSelect.value : '1:1';
...
                        originalImg.className = originalImg.className.replace(/aspect-\[.*?\]|aspect-video|aspect-square/g, '');
                        originalImg.classList.add(newAspectClass);
                        */
                        // --- AKHIR BARU ---
                    }

                    if (originalDownload) originalDownload.href = newSrc;

                    // Perbarui base64 di data kartu aktif untuk editan selanjutnya
                    activeEditCard.base64 = newEditedBase64;
                    
                    if(editModal) editModal.classList.add('hidden'); // Tutup modal
                    showToast("Gambar telah diganti!");
                    newEditedBase64 = null; // Bersihkan
                });
            }
            // --- AKHIR LOGIKA MODAL EDIT ---


            // --- Tool SB: Storyboard Director ---
            const sbSetupContainer = document.getElementById('sb-setup-container');
            const sbProgressContainer = document.getElementById('sb-progress-container');
            const sbCharacterSheetContainer = document.getElementById('sb-character-sheet-container');
            const sbCharacterSheetContent = document.getElementById('sb-character-sheet-content');
            const sbControlsContainer = document.getElementById('sb-controls-container');
            const sbStoryboardContainer = document.getElementById('sb-storyboard-container');
            const sbStoryForm = document.getElementById('sb-story-form');
            const sbGenerateBtn = document.getElementById('sb-generate-btn');
            const sbRestartBtn = document.getElementById('sb-restart-btn');
            const sbStatusText = document.getElementById('sb-status-text');
            const sbProgressBarFill = document.getElementById('sb-progress-bar-fill');
            const sbProgressLabel = document.getElementById('sb-progress-label');
            const sbAspectRatioSelector = document.getElementById('sb-aspect-ratio-selector');
            const sbSceneCountInput = document.getElementById('sb-scene-count');
            const sbSceneWarning = document.getElementById('sb-scene-warning');

            let sbCharacterImageBase64 = [null, null, null];

            async function sbMakeApiCall(url, payload) {
                let delay = 2000;
                for (let i = 0; i < 3; i++) {
                    try {
                        const response = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                        if (!response.ok) {
                            const errorBody = await response.text();
                            throw new Error(`HTTP error! status: ${response.status}, body: ${errorBody}`);
                        }
                        return response.json();
                    } catch (error) {
                        console.error(`API call attempt ${i + 1} failed:`, error);
                        if (i === 2) throw error;
                        await new Promise(resolve => setTimeout(resolve, delay));
                        delay *= 2;
                    }
                }
            }

            async function sbGenerateCharacterAndScript({ title, characterInput, sceneCount, aspectRatio, visualStyle, characterImages }) {
                if(sbStatusText) sbStatusText.textContent = "Menganalisis Referensi & Membangun Naskah...";
                sbUpdateProgress(5, sceneCount, "Tahap 1 dari 3");

                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${API_KEY}`;
                
                const contentParts = [{ text: `Judul Cerita: ${title}\nDeskripsi Teks Karakter: ${characterInput}` }];
                characterImages.forEach(imgData => {
                    if (imgData) {
                        contentParts.push({ text: "Berikut adalah gambar referensi untuk karakter utama:" });
                        contentParts.push({
                            inlineData: { mimeType: 'image/jpeg', data: imgData }
                        });
                    }
                });

                const systemPrompt = `Anda adalah seorang sutradara dan penulis skenario AI multi-modal. Tugas Anda:
1.  **ANALISIS & BUAT CHARACTER SHEET:** Berdasarkan deskripsi teks pengguna DAN gambar referensi yang disediakan, analisis fitur visualnya (wajah, rambut, pakaian, gaya) dan buat deskripsi karakter (Character Sheet) yang sangat detail untuk konsistensi visual. Ini adalah langkah paling penting.
2.  **TULIS NASKAH:** Kembangkan cerita dari judul menjadi TEPAT ${sceneCount} adegan.
3.  **HASILKAN PROMPT GAMBAR & DIALOG:** Untuk setiap adegan, hasilkan:
    a. 'prompt': Deskripsi dalam Bahasa Inggris untuk AI generator gambar. Ini HARUS menyertakan: gaya visual (**${visualStyle}**), aspek rasio (${aspectRatio}), detail karakter dari Character Sheet yang telah Anda buat, pergerakan kamera, aksi, dan suasana.
    b. 'dialogue': Dialog atau narasi singkat adegan dalam Bahasa Indonesia.`;

                const payload = {
                    contents: [{ parts: contentParts }],
                    systemInstruction: { parts: [{ text: systemPrompt }] },
                    generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: {
                            type: "OBJECT",
                            properties: {
                                characterSheet: { type: "STRING" },
                                storyboards: { type: "ARRAY", items: { type: "OBJECT", properties: { prompt: { type: "STRING" }, dialogue: {type: "STRING"} }, required: ["prompt", "dialogue"] } }
                            },
                            required: ["characterSheet", "storyboards"]
                        }
                    }
                };
                
                const result = await sbMakeApiCall(apiUrl, payload);
                const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;
                if (!jsonText) throw new Error("API response did not contain valid JSON text for script.");
                const scriptData = JSON.parse(jsonText);
                if (!scriptData.storyboards || scriptData.storyboards.length === 0) throw new Error("AI gagal membuat struktur cerita.");
                return scriptData;
            }

            async function sbGenerateImage(prompt) {
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/imagen-3.0-generate-002:predict?key=${API_KEY}`;
                const payload = { instances: [{ prompt }], parameters: { "sampleCount": 1 } };
                const result = await sbMakeApiCall(apiUrl, payload);
                if (result.predictions && result.predictions[0]?.bytesBase64Encoded) {
                    return `data:image/png;base64,${result.predictions[0].bytesBase64Encoded}`;
                }
                return 'https://placehold.co/512x512/1e293b/e2e8f0?text=Error';
            }

            function sbUpdateProgress(current, total, labelPrefix = "") {
                const percentage = total > 0 ? (current / total) * 100 : 0;
                if(sbProgressBarFill) sbProgressBarFill.style.width = `${percentage}%`;
                if(sbProgressLabel) sbProgressLabel.textContent = `${labelPrefix ? labelPrefix + ': ' : ''}${current} / ${total}`;
            }

            function sbCreatePanelElement(panelData, index) {
                const panel = document.createElement('div');
                panel.id = `sb-panel-${index}`;
                panel.className = 'storyboard-panel rounded-lg shadow-lg overflow-hidden flex flex-col';
                panel.style.animationDelay = `${index * 50}ms`;

                const activeAspectRatioBtn = sbAspectRatioSelector ? sbAspectRatioSelector.querySelector('.sb-aspect-ratio-btn.active') : null;
                const aspectRatio = activeAspectRatioBtn ? activeAspectRatioBtn.dataset.value : '16:9';
                 const aspectRatioClass = {
                    '16:9': 'aspect-video', '1:1': 'aspect-square', '9:16': 'aspect-[9/16]',
                    '2.39:1': 'aspect-[2.39/1]', '4:3': 'aspect-[4/3]', '4:5': 'aspect-[4/5]'
                }[aspectRatio] || 'aspect-video';
                
                const sceneJson = { video_prompt: panelData.prompt, dialogue: panelData.dialogue };
                const prettyJson = JSON.stringify(sceneJson, null, 2);

                panel.innerHTML = `
                    <div class="p-3 flex justify-between items-center" style="border-bottom: 1px solid var(--border-color);">
                        <h3 class="font-bold text-white">Adegan #${index + 1}</h3>
                    </div>
                    <div class="sb-image-container ${aspectRatioClass} flex items-center justify-center" style="background-color: var(--bg-primary);">
                        <div class="custom-loader"></div>
                    </div>
                    <div class="p-3 space-y-3" style="background-color: var(--bg-secondary); border-top: 1px solid var(--border-color);">
                        <div>
                            <label class="text-xs font-medium" style="color: var(--text-secondary);">Prompt Video (JSON)</label>
                            <textarea readonly class="sb-form-textarea w-full text-xs h-32 rounded-md mt-1" style="background-color: var(--bg-primary);">${prettyJson}</textarea>
                        </div>
                        <button class="sb-download-png-btn w-full sb-btn-secondary text-sm py-1.5 rounded-md invisible">Unduh PNG</button>
                    </div>`;
                return panel;
            }
            
            function sbHandleImageUpload(event) {
                const index = parseInt(event.target.dataset.index, 10);
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onloadend = () => {
                    const base64String = reader.result.replace('data:', '').replace(/^.+,/, '');
                    sbCharacterImageBase64[index] = base64String;
                    const previewEl = document.getElementById(`sb-image-preview-${index + 1}`);
                    const uploadPromptEl = document.getElementById(`sb-upload-prompt-${index + 1}`);
                    const previewContainerEl = document.getElementById(`sb-image-preview-container-${index + 1}`);
                    if(previewEl) previewEl.src = reader.result;
                    if(uploadPromptEl) uploadPromptEl.parentElement.classList.add('hidden');
                    if(previewContainerEl) previewContainerEl.classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            }

            function sbRemoveImage(index) {
                sbCharacterImageBase64[index] = null;
                const input = document.getElementById(`sb-image-upload-${index + 1}`);
                if(input) input.value = '';
                const previewEl = document.getElementById(`sb-image-preview-${index + 1}`);
                const uploadPromptEl = document.getElementById(`sb-upload-prompt-${index + 1}`);
                const previewContainerEl = document.getElementById(`sb-image-preview-container-${index + 1}`);
                if(previewEl) previewEl.src = '';
                if(uploadPromptEl) uploadPromptEl.parentElement.classList.remove('hidden');
                if(previewContainerEl) previewContainerEl.classList.add('hidden');
            }

            async function sbRunGenerationProcess() {
                let sceneCount = sbSceneCountInput ? parseInt(sbSceneCountInput.value, 10) : 12;
                if (isNaN(sceneCount) || sceneCount < 1) { alert("Jumlah adegan tidak valid."); return; }
                if (sceneCount > 100) { alert("Untuk stabilitas, jumlah adegan dibatasi hingga 100."); sceneCount = 100; if(sbSceneCountInput) sbSceneCountInput.value = 100; }

                if(sbGenerateBtn) sbGenerateBtn.disabled = true;
                if(sbSetupContainer) sbSetupContainer.classList.add('hidden');
                if(sbProgressContainer) sbProgressContainer.classList.remove('hidden');

                try {
                    const titleEl = document.getElementById('sb-story-title');
                    const charDescEl = document.getElementById('sb-character-description');
                    const aspectBtn = sbAspectRatioSelector ? sbAspectRatioSelector.querySelector('.sb-aspect-ratio-btn.active') : null;
                    const styleEl = document.getElementById('sb-visual-style');
                    
                    const scriptData = await sbGenerateCharacterAndScript({
                        title: titleEl ? titleEl.value.trim() : 'Cerita',
                        characterInput: charDescEl ? charDescEl.value.trim() : '',
                        sceneCount,
                        aspectRatio: aspectBtn ? aspectBtn.dataset.value : '16:9',
                        visualStyle: styleEl ? styleEl.value : 'photorealistic',
                        characterImages: sbCharacterImageBase64.filter(img => img !== null)
                    });
                    
                    if(sbCharacterSheetContent) sbCharacterSheetContent.textContent = scriptData.characterSheet;
                    if(sbCharacterSheetContainer) sbCharacterSheetContainer.classList.remove('hidden');
                    if(sbStatusText) sbStatusText.textContent = "Naskah selesai! Menghasilkan gambar...";
                    
                    for (let i = 0; i < scriptData.storyboards.length; i++) {
                        const panelData = scriptData.storyboards[i];
                        const panelElement = sbCreatePanelElement(panelData, i);
                        if(sbStoryboardContainer) sbStoryboardContainer.appendChild(panelElement);
                        sbUpdateProgress(i + 1, sceneCount, "Tahap 2 dari 3"); // Update +1
                        
                        const imageUrl = await sbGenerateImage(panelData.prompt);
                        
                        const imageContainer = panelElement.querySelector('.sb-image-container');
                        const downloadBtn = panelElement.querySelector('.sb-download-png-btn');
                        if(imageContainer) imageContainer.innerHTML = `<img src="${imageUrl}" alt="Adegan ${i + 1}" class="w-full h-full object-cover">`;
                        if(downloadBtn) downloadBtn.classList.remove('invisible');
                    }

                    sbUpdateProgress(sceneCount, sceneCount, "Selesai");
                    if(sbStatusText) sbStatusText.textContent = "Storyboard Selesai!";
                    if(sbProgressContainer) sbProgressContainer.classList.add('hidden');
                    if(sbControlsContainer) sbControlsContainer.classList.remove('hidden');
                } catch (error) {
                    console.error("Proses pembuatan gagal:", error);
                    if(sbStatusText) sbStatusText.textContent = "Terjadi Kesalahan Fatal!";
                    if(sbProgressLabel) sbProgressLabel.textContent = `Error: ${error.message}. Coba lagi.`;
                    if(sbProgressBarFill) sbProgressBarFill.style.backgroundColor = '#ef4444'; // Error red
                    if(sbControlsContainer) sbControlsContainer.classList.remove('hidden');
                }
            }
            
            function sbResetUI() {
                if(sbStoryboardContainer) sbStoryboardContainer.innerHTML = '';
                if(sbSetupContainer) sbSetupContainer.classList.remove('hidden');
                if(sbProgressContainer) sbProgressContainer.classList.add('hidden');
                if(sbControlsContainer) sbControlsContainer.classList.add('hidden');
                if(sbCharacterSheetContainer) sbCharacterSheetContainer.classList.add('hidden');
                if(sbGenerateBtn) sbGenerateBtn.disabled = false;
                if(sbStoryForm) sbStoryForm.reset();
                for (let i = 0; i < 3; i++) { sbRemoveImage(i); }
                if (sbAspectRatioSelector) {
                     sbAspectRatioSelector.querySelectorAll('.sb-aspect-ratio-btn').forEach(btn => btn.classList.remove('active'));
                    const defaultAspect = sbAspectRatioSelector.querySelector('.sb-aspect-ratio-btn[data-value="16:9"]');
                    if(defaultAspect) defaultAspect.classList.add('active');
                }
                if(sbProgressBarFill) { sbProgressBarFill.style.width = '0%'; sbProgressBarFill.style.backgroundColor = 'var(--accent-primary)'; }
                if(sbSceneWarning) sbSceneWarning.classList.add('hidden');
            }

            if(sbStoryForm) sbStoryForm.addEventListener('submit', (e) => { e.preventDefault(); sbRunGenerationProcess(); });
            if(sbRestartBtn) sbRestartBtn.addEventListener('click', sbResetUI);
            
            document.querySelectorAll('#storyboard-director input[type="file"]').forEach(input => input.addEventListener('change', sbHandleImageUpload));
            document.querySelectorAll('.sb-remove-image-btn').forEach(button => button.addEventListener('click', (e) => sbRemoveImage(parseInt(e.currentTarget.dataset.index, 10))));

            if(sbAspectRatioSelector) sbAspectRatioSelector.addEventListener('click', (e) => {
                if (e.target.tagName === 'BUTTON' && e.target.classList.contains('sb-aspect-ratio-btn')) {
                    sbAspectRatioSelector.querySelectorAll('.sb-aspect-ratio-btn').forEach(btn => btn.classList.remove('active'));
                    e.target.classList.add('active');
                }
            });
            
            if(sbSceneCountInput) sbSceneCountInput.addEventListener('input', (e) => {
                if(sbSceneWarning) sbSceneWarning.classList.toggle(parseInt(e.target.value, 10) > 30, true);
            });
            
            if(sbStoryboardContainer) sbStoryboardContainer.addEventListener('click', function(e) {
                const downloadBtn = e.target.closest('.sb-download-png-btn');
                if (downloadBtn) {
                    const panel = downloadBtn.closest('.storyboard-panel');
                    const img = panel.querySelector('.sb-image-container img');
                    const titleEl = document.getElementById('sb-story-title');
                    if (img && img.src && panel) {
                        const sceneNumber = parseInt(panel.id.split('-')[2], 10) + 1;
                        const title = (titleEl && titleEl.value.trim() ? titleEl.value.trim() : 'storyboard').replace(/[^a-zA-Z0-9]/g, '_');
                        const filename = `${title}-Adegan-${sceneNumber}.png`;

                        const a = document.createElement('a');
                        a.href = img.src;
                        a.download = filename;
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                    }
                }
            });

        });
    </script>
</body>
</html>